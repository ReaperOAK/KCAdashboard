var LichessPgnViewer=function(){"use strict";const e=["a","b","c","d","e","f","g","h"],t=["1","2","3","4","5","6","7","8"],n=["white","black"],s=["pawn","knight","bishop","rook","queen","king"],r=["a","h"],o=e=>"role"in e,i=e=>void 0!==e,a=e=>"white"===e?"black":"white",c=e=>e>>3,h=e=>7&e,l=e=>{switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function u(e){switch(e.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function d(e){if(2!==e.length)return;const t=e.charCodeAt(0)-"a".charCodeAt(0),n=e.charCodeAt(1)-"1".charCodeAt(0);return t<0||t>=8||n<0||n>=8?void 0:t+8*n}const p=n=>e[h(n)]+t[c(n)],f=e=>o(e)?`${l(e.role).toUpperCase()}@${p(e.to)}`:p(e.from)+p(e.to)+(e.promotion?l(e.promotion):""),m=(e,t)=>"white"===e?"a"===t?2:6:"a"===t?58:62,g=e=>(e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),v=e=>(e=e>>>8&16711935|(16711935&e)<<8)>>>16&65535|(65535&e)<<16,b=e=>v(e=(e=(e=e>>>1&1431655765|(1431655765&e)<<1)>>>2&858993459|(858993459&e)<<2)>>>4&252645135|(252645135&e)<<4);class k{constructor(e,t){this.lo=0|e,this.hi=0|t}static fromSquare(e){return e>=32?new k(0,1<<e-32):new k(1<<e,0)}static fromRank(e){return new k(255,0).shl64(8*e)}static fromFile(e){return new k(16843009<<e,16843009<<e)}static empty(){return new k(0,0)}static full(){return new k(4294967295,4294967295)}static corners(){return new k(129,2164260864)}static center(){return new k(402653184,24)}static backranks(){return new k(255,4278190080)}static backrank(e){return"white"===e?new k(255,0):new k(0,4278190080)}static lightSquares(){return new k(1437226410,1437226410)}static darkSquares(){return new k(2857740885,2857740885)}complement(){return new k(~this.lo,~this.hi)}xor(e){return new k(this.lo^e.lo,this.hi^e.hi)}union(e){return new k(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new k(this.lo&e.lo,this.hi&e.hi)}diff(e){return new k(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?k.empty():e>=32?new k(this.hi>>>e-32,0):e>0?new k(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?k.empty():e>=32?new k(0,this.lo<<e-32):e>0?new k(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new k(v(this.hi),v(this.lo))}rbit64(){return new k(b(this.hi),b(this.lo))}minus64(e){const t=this.lo-e.lo,n=(t&e.lo&1)+(e.lo>>>1)+(t>>>1)>>>31;return new k(t,this.hi-(e.hi+n))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return g(this.lo)+g(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(e){return 0!=(e>=32?this.hi&1<<e-32:this.lo&1<<e)}set(e,t){return t?this.with(e):this.without(e)}with(e){return e>=32?new k(this.lo,this.hi|1<<e-32):new k(this.lo|1<<e,this.hi)}without(e){return e>=32?new k(this.lo,this.hi&~(1<<e-32)):new k(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new k(this.lo,this.hi^1<<e-32):new k(this.lo^1<<e,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new k(this.lo&this.lo-1,this.hi):new k(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||0!=(this.lo&this.lo-1)||0!=(this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let e=this.lo,t=this.hi;for(;0!==e;){const t=31-Math.clz32(e&-e);e^=1<<t,yield t}for(;0!==t;){const e=31-Math.clz32(t&-t);t^=1<<e,yield 32+e}}*reversed(){let e=this.lo,t=this.hi;for(;0!==t;){const e=31-Math.clz32(t);t^=1<<e,yield 32+e}for(;0!==e;){const t=31-Math.clz32(e);e^=1<<t,yield t}}}const w=(e,t)=>{let n=k.empty();for(const s of t){const t=e+s;0<=t&&t<64&&Math.abs(h(e)-h(t))<=2&&(n=n.with(t))}return n},y=e=>{const t=[];for(let n=0;n<64;n++)t[n]=e(n);return t},C=y((e=>w(e,[-9,-8,-7,-1,1,7,8,9]))),S=y((e=>w(e,[-17,-15,-10,-6,6,10,15,17]))),E={white:y((e=>w(e,[7,9]))),black:y((e=>w(e,[-7,-9])))},x=e=>C[e],_=e=>S[e],q=(e,t)=>E[e][t],M=y((e=>k.fromFile(h(e)).without(e))),O=y((e=>k.fromRank(c(e)).without(e))),A=y((e=>{const t=new k(134480385,2151686160),n=8*(c(e)-h(e));return(n>=0?t.shl64(n):t.shr64(-n)).without(e)})),P=y((e=>{const t=new k(270549120,16909320),n=8*(c(e)+h(e)-7);return(n>=0?t.shl64(n):t.shr64(-n)).without(e)})),R=(e,t,n)=>{let s=n.intersect(t),r=s.bswap64();return s=s.minus64(e),r=r.minus64(e.bswap64()),s.xor(r.bswap64()).intersect(t)},N=(e,t)=>{const n=k.fromSquare(e);return R(n,A[e],t).xor(R(n,P[e],t))},T=(e,t)=>((e,t)=>R(k.fromSquare(e),M[e],t))(e,t).xor(((e,t)=>{const n=O[e];let s=t.intersect(n),r=s.rbit64();return s=s.minus64(k.fromSquare(e)),r=r.minus64(k.fromSquare(63-e)),s.xor(r.rbit64()).intersect(n)})(e,t)),B=(e,t)=>N(e,t).xor(T(e,t)),L=(e,t,n)=>{switch(e.role){case"pawn":return q(e.color,t);case"knight":return _(t);case"bishop":return N(t,n);case"rook":return T(t,n);case"queen":return B(t,n);case"king":return x(t)}},K=(e,t)=>{const n=k.fromSquare(t);return O[e].intersects(n)?O[e].with(e):P[e].intersects(n)?P[e].with(e):A[e].intersects(n)?A[e].with(e):M[e].intersects(n)?M[e].with(e):k.empty()},z=(e,t)=>K(e,t).intersect(k.full().shl64(e).xor(k.full().shl64(t))).withoutFirst();class D{constructor(){}static default(){const e=new D;return e.reset(),e}reset(){this.occupied=new k(65535,4294901760),this.promoted=k.empty(),this.white=new k(65535,0),this.black=new k(0,4294901760),this.pawn=new k(65280,16711680),this.knight=new k(66,1107296256),this.bishop=new k(36,603979776),this.rook=new k(129,2164260864),this.queen=new k(8,134217728),this.king=new k(16,268435456)}static empty(){const e=new D;return e.clear(),e}clear(){this.occupied=k.empty(),this.promoted=k.empty();for(const e of n)this[e]=k.empty();for(const e of s)this[e]=k.empty()}clone(){const e=new D;e.occupied=this.occupied,e.promoted=this.promoted;for(const t of n)e[t]=this[t];for(const t of s)e[t]=this[t];return e}getColor(e){return this.white.has(e)?"white":this.black.has(e)?"black":void 0}getRole(e){for(const t of s)if(this[t].has(e))return t}get(e){const t=this.getColor(e);if(!t)return;return{color:t,role:this.getRole(e),promoted:this.promoted.has(e)}}take(e){const t=this.get(e);return t&&(this.occupied=this.occupied.without(e),this[t.color]=this[t.color].without(e),this[t.role]=this[t.role].without(e),t.promoted&&(this.promoted=this.promoted.without(e))),t}set(e,t){const n=this.take(e);return this.occupied=this.occupied.with(e),this[t.color]=this[t.color].with(e),this[t.role]=this[t.role].with(e),t.promoted&&(this.promoted=this.promoted.with(e)),n}has(e){return this.occupied.has(e)}*[Symbol.iterator](){for(const e of this.occupied)yield[e,this.get(e)]}pieces(e,t){return this[e].intersect(this[t])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.pieces(e,"king").singleSquare()}}class I{constructor(){}static empty(){const e=new I;for(const t of s)e[t]=0;return e}static fromBoard(e,t){const n=new I;for(const r of s)n[r]=e.pieces(t,r).size();return n}clone(){const e=new I;for(const t of s)e[t]=this[t];return e}equals(e){return s.every((t=>this[t]===e[t]))}add(e){const t=new I;for(const n of s)t[n]=this[n]+e[n];return t}nonEmpty(){return s.some((e=>this[e]>0))}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class ${constructor(e,t){this.white=e,this.black=t}static empty(){return new $(I.empty(),I.empty())}static fromBoard(e){return new $(I.fromBoard(e,"white"),I.fromBoard(e,"black"))}clone(){return new $(this.white.clone(),this.black.clone())}equals(e){return this.white.equals(e.white)&&this.black.equals(e.black)}add(e){return new $(this.white.add(e.white),this.black.add(e.black))}count(e){return this.white[e]+this.black[e]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class U{constructor(e,t){this.white=e,this.black=t}static default(){return new U(3,3)}clone(){return new U(this.white,this.black)}equals(e){return this.white===e.white&&this.black===e.black}}class F{unwrap(e,t){const n=this._chain((t=>j.ok(e?e(t):t)),(e=>t?j.ok(t(e)):j.err(e)));if(n.isErr)throw n.error;return n.value}map(e,t){return this._chain((t=>j.ok(e(t))),(e=>j.err(t?t(e):e)))}chain(e,t){return this._chain(e,t||(e=>j.err(e)))}}class G extends F{constructor(e){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=e}_chain(e,t){return e(this.value)}}class V extends F{constructor(e){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=e}_chain(e,t){return t(this.error)}}var j,H;!function(e){e.ok=function(e){return new G(e)},e.err=function(e){return new V(e||new Error)},e.all=function(t){if(Array.isArray(t)){const n=[];for(let e=0;e<t.length;e++){const s=t[e];if(s.isErr)return s;n.push(s.value)}return e.ok(n)}const n={},s=Object.keys(t);for(let e=0;e<s.length;e++){const r=t[s[e]];if(r.isErr)return r;n[s[e]]=r.value}return e.ok(n)}}(j||(j={})),function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.ImpossibleCheck="ERR_IMPOSSIBLE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"}(H||(H={}));class W extends Error{}const Q=(e,t)=>"white"===e?"a"===t?3:5:"a"===t?59:61;class Y{constructor(){}static default(){const e=new Y;return e.unmovedRooks=k.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new k(14,0),h:new k(96,0)},black:{a:new k(0,234881024),h:new k(0,1610612736)}},e}static empty(){const e=new Y;return e.unmovedRooks=k.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:k.empty(),h:k.empty()},black:{a:k.empty(),h:k.empty()}},e}clone(){const e=new Y;return e.unmovedRooks=this.unmovedRooks,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,t,n,s){const r=m(e,t),o=Q(e,t);this.unmovedRooks=this.unmovedRooks.with(s),this.rook[e][t]=s,this.path[e][t]=z(s,o).with(o).union(z(n,r).with(r)).without(n).without(s)}static fromSetup(e){const t=Y.empty(),s=e.unmovedRooks.intersect(e.board.rook);for(const r of n){const n=k.backrank(r),o=e.board.kingOf(r);if(!i(o)||!n.has(o))continue;const a=s.intersect(e.board[r]).intersect(n),c=a.first();i(c)&&c<o&&t.add(r,"a",o,c);const h=a.last();i(h)&&o<h&&t.add(r,"h",o,h)}return t}discardRook(e){if(this.unmovedRooks.has(e)){this.unmovedRooks=this.unmovedRooks.without(e);for(const t of n)for(const n of r)this.rook[t][n]===e&&(this.rook[t][n]=void 0)}}discardColor(e){this.unmovedRooks=this.unmovedRooks.diff(k.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}}class Z{constructor(e){this.rules=e}reset(){this.board=D.default(),this.pockets=void 0,this.turn="white",this.castles=Y.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(e){this.board=e.board.clone(),this.board.promoted=k.empty(),this.pockets=void 0,this.turn=e.turn,this.castles=Y.fromSetup(e),this.epSquare=J(this,e.epSquare),this.remainingChecks=void 0,this.halfmoves=e.halfmoves,this.fullmoves=e.fullmoves}kingAttackers(e,t,n){return((e,t,n,s)=>n[t].intersect(T(e,s).intersect(n.rooksAndQueens()).union(N(e,s).intersect(n.bishopsAndQueens())).union(_(e).intersect(n.knight)).union(x(e).intersect(n.king)).union(q(a(t),e).intersect(n.pawn))))(e,t,this.board,n)}playCaptureAt(e,t){this.halfmoves=0,"rook"===t.role&&this.castles.discardRook(e),this.pockets&&this.pockets[a(t.color)][t.promoted?"pawn":t.role]++}ctx(){const e=this.isVariantEnd(),t=this.board.kingOf(this.turn);if(!i(t))return{king:t,blockers:k.empty(),checkers:k.empty(),variantEnd:e,mustCapture:!1};const n=T(t,k.empty()).intersect(this.board.rooksAndQueens()).union(N(t,k.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[a(this.turn)]);let s=k.empty();for(const e of n){const n=z(t,e).intersect(this.board.occupied);n.moreThanOne()||(s=s.union(n))}return{king:t,blockers:s,checkers:this.kingAttackers(t,a(this.turn),this.board.occupied),variantEnd:e,mustCapture:!1}}clone(){var e,t;const n=new this.constructor;return n.board=this.board.clone(),n.pockets=null===(e=this.pockets)||void 0===e?void 0:e.clone(),n.turn=this.turn,n.castles=this.castles.clone(),n.epSquare=this.epSquare,n.remainingChecks=null===(t=this.remainingChecks)||void 0===t?void 0:t.clone(),n.halfmoves=this.halfmoves,n.fullmoves=this.fullmoves,n}validate(e){if(this.board.occupied.isEmpty())return j.err(new W(H.Empty));if(2!==this.board.king.size())return j.err(new W(H.Kings));if(!i(this.board.kingOf(this.turn)))return j.err(new W(H.Kings));const t=this.board.kingOf(a(this.turn));return i(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?j.err(new W(H.OppositeCheck)):k.backranks().intersects(this.board.pawn)?j.err(new W(H.PawnsOnBackrank)):(null==e?void 0:e.ignoreImpossibleCheck)?j.ok(void 0):this.validateCheckers():j.err(new W(H.Kings))}validateCheckers(){const e=this.board.kingOf(this.turn);if(i(e)){const t=this.kingAttackers(e,a(this.turn),this.board.occupied);if(t.nonEmpty())if(i(this.epSquare)){const n=8^this.epSquare,s=24^this.epSquare;if(t.moreThanOne()||t.first()!==n&&this.kingAttackers(e,a(this.turn),this.board.occupied.without(n).with(s)).nonEmpty())return j.err(new W(H.ImpossibleCheck))}else if(t.size()>2||2===t.size()&&K(t.first(),t.last()).has(e))return j.err(new W(H.ImpossibleCheck))}return j.ok(void 0)}dropDests(e){return k.empty()}dests(e,t){if((t=t||this.ctx()).variantEnd)return k.empty();const n=this.board.get(e);if(!n||n.color!==this.turn)return k.empty();let s,r;if("pawn"===n.role){s=q(this.turn,e).intersect(this.board[a(this.turn)]);const n="white"===this.turn?8:-8,o=e+n;if(0<=o&&o<64&&!this.board.occupied.has(o)){s=s.with(o);const t=o+n;("white"===this.turn?e<16:e>=48)&&!this.board.occupied.has(t)&&(s=s.with(t))}if(i(this.epSquare)&&te(this,e,t)){const e=this.epSquare-n;(t.checkers.isEmpty()||t.checkers.singleSquare()===e)&&(r=k.fromSquare(this.epSquare))}}else s="bishop"===n.role?N(e,this.board.occupied):"knight"===n.role?_(e):"rook"===n.role?T(e,this.board.occupied):"queen"===n.role?B(e,this.board.occupied):x(e);if(s=s.diff(this.board[this.turn]),i(t.king)){if("king"===n.role){const n=this.board.occupied.without(e);for(const e of s)this.kingAttackers(e,a(this.turn),n).nonEmpty()&&(s=s.without(e));return s.union(ne(this,"a",t)).union(ne(this,"h",t))}if(t.checkers.nonEmpty()){const e=t.checkers.singleSquare();if(!i(e))return k.empty();s=s.intersect(z(e,t.king).with(e))}t.blockers.has(e)&&(s=s.intersect(K(e,t.king)))}return r&&(s=s.union(r)),s}isVariantEnd(){return!1}variantOutcome(e){}hasInsufficientMaterial(e){if(this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty())return!1;if(this.board[e].intersects(this.board.knight))return this.board[e].size()<=2&&this.board[a(e)].diff(this.board.king).diff(this.board.queen).isEmpty();if(this.board[e].intersects(this.board.bishop)){return(!this.board.bishop.intersects(k.darkSquares())||!this.board.bishop.intersects(k.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty()}return!0}toSetup(){var e,t;return{board:this.board.clone(),pockets:null===(e=this.pockets)||void 0===e?void 0:e.clone(),turn:this.turn,unmovedRooks:this.castles.unmovedRooks,epSquare:ee(this),remainingChecks:null===(t=this.remainingChecks)||void 0===t?void 0:t.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return n.every((e=>this.hasInsufficientMaterial(e)))}hasDests(e){e=e||this.ctx();for(const t of this.board[this.turn])if(this.dests(t,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,t){if(o(e))return!(!this.pockets||this.pockets[this.turn][e.role]<=0)&&(("pawn"!==e.role||!k.backranks().has(e.to))&&this.dropDests(t).has(e.to));{if("pawn"===e.promotion)return!1;if("king"===e.promotion&&"antichess"!==this.rules)return!1;if(!!e.promotion!==(this.board.pawn.has(e.from)&&k.backranks().has(e.to)))return!1;const n=this.dests(e.from,t);return n.has(e.to)||n.has(oe(this,e).to)}}isCheck(){const e=this.board.kingOf(this.turn);return i(e)&&this.kingAttackers(e,a(this.turn),this.board.occupied).nonEmpty()}isEnd(e){return!!(e?e.variantEnd:this.isVariantEnd())||(this.isInsufficientMaterial()||!this.hasDests(e))}isCheckmate(e){return!(e=e||this.ctx()).variantEnd&&e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(e){return!(e=e||this.ctx()).variantEnd&&e.checkers.isEmpty()&&!this.hasDests(e)}outcome(e){const t=this.variantOutcome(e);return t||(e=e||this.ctx(),this.isCheckmate(e)?{winner:a(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(e)?{winner:void 0}:void 0)}allDests(e){e=e||this.ctx();const t=new Map;if(e.variantEnd)return t;for(const n of this.board[this.turn])t.set(n,this.dests(n,e));return t}play(e){const t=this.turn,n=this.epSquare,s=re(this,e);if(this.epSquare=void 0,this.halfmoves+=1,"black"===t&&(this.fullmoves+=1),this.turn=a(t),o(e))this.board.set(e.to,{role:e.role,color:t}),this.pockets&&this.pockets[t][e.role]--,"pawn"===e.role&&(this.halfmoves=0);else{const r=this.board.take(e.from);if(!r)return;let o;if("pawn"===r.role){this.halfmoves=0,e.to===n&&(o=this.board.take(e.to+("white"===t?-8:8)));const s=e.from-e.to;16===Math.abs(s)&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(r.role=e.promotion,r.promoted=!!this.pockets)}else if("rook"===r.role)this.castles.discardRook(e.from);else if("king"===r.role){if(s){const e=this.castles.rook[t][s];if(i(e)){const n=this.board.take(e);this.board.set(m(t,s),r),n&&this.board.set(Q(t,s),n)}}this.castles.discardColor(t)}if(!s){const t=this.board.set(e.to,r)||o;t&&this.playCaptureAt(e.to,t)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[t]=Math.max(this.remainingChecks[t]-1,0))}}class X extends Z{constructor(){super("chess")}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}}const J=(e,t)=>{if(!i(t))return;const n="white"===e.turn?5:2,s="white"===e.turn?8:-8;if(c(t)!==n)return;if(e.board.occupied.has(t+s))return;const r=t-s;return e.board.pawn.has(r)&&e.board[a(e.turn)].has(r)?t:void 0},ee=e=>{if(!i(e.epSquare))return;const t=e.ctx(),n=e.board.pieces(e.turn,"pawn").intersect(q(a(e.turn),e.epSquare));for(const s of n)if(e.dests(s,t).has(e.epSquare))return e.epSquare},te=(e,t,n)=>{if(!i(e.epSquare))return!1;if(!q(e.turn,t).has(e.epSquare))return!1;if(!i(n.king))return!0;const s=e.epSquare+("white"===e.turn?-8:8),r=e.board.occupied.toggle(t).toggle(e.epSquare).toggle(s);return!e.kingAttackers(n.king,a(e.turn),r).intersects(r)},ne=(e,t,n)=>{if(!i(n.king)||n.checkers.nonEmpty())return k.empty();const s=e.castles.rook[e.turn][t];if(!i(s))return k.empty();if(e.castles.path[e.turn][t].intersects(e.board.occupied))return k.empty();const r=m(e.turn,t),o=z(n.king,r),c=e.board.occupied.without(n.king);for(const t of o)if(e.kingAttackers(t,a(e.turn),c).nonEmpty())return k.empty();const h=Q(e.turn,t),l=e.board.occupied.toggle(n.king).toggle(s).toggle(h);return e.kingAttackers(r,a(e.turn),l).nonEmpty()?k.empty():k.fromSquare(s)},se=(e,t,n)=>{if(n.variantEnd)return k.empty();const s=e.board.get(t);if(!s||s.color!==e.turn)return k.empty();let r=L(s,t,e.board.occupied);if("pawn"===s.role){let n=e.board[a(e.turn)];i(e.epSquare)&&(n=n.with(e.epSquare)),r=r.intersect(n);const s="white"===e.turn?8:-8,o=t+s;if(0<=o&&o<64&&!e.board.occupied.has(o)){r=r.with(o);const n=o+s;("white"===e.turn?t<16:t>=48)&&!e.board.occupied.has(n)&&(r=r.with(n))}return r}return r=r.diff(e.board[e.turn]),t===n.king?r.union(ne(e,"a",n)).union(ne(e,"h",n)):r},re=(e,t)=>{if(o(t))return;const n=t.to-t.from;return(2===Math.abs(n)||e.board[e.turn].has(t.to))&&e.board.king.has(t.from)?n>0?"h":"a":void 0},oe=(e,t)=>{const n=re(e,t);if(!n)return t;const s=e.castles.rook[e.turn][n];return{from:t.from,to:i(s)?s:t.to}};var ie;!function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"}(ie||(ie={}));class ae extends Error{}const ce=e=>/^\d{1,4}$/.test(e)?parseInt(e,10):void 0,he=e=>{const t=u(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}},le=e=>{const t=D.empty();let n=7,s=0;for(let r=0;r<e.length;r++){const o=e[r];if("/"===o&&8===s)s=0,n--;else{const i=parseInt(o,10);if(i>0)s+=i;else{if(s>=8||n<0)return j.err(new ae(ie.Board));const i=s+8*n,a=he(o);if(!a)return j.err(new ae(ie.Board));"~"===e[r+1]&&(a.promoted=!0,r++),t.set(i,a),s++}}}return 0!==n||8!==s?j.err(new ae(ie.Board)):j.ok(t)},ue=e=>{if(e.length>64)return j.err(new ae(ie.Pockets));const t=$.empty();for(const n of e){const e=he(n);if(!e)return j.err(new ae(ie.Pockets));t[e.color][e.role]++}return j.ok(t)},de=e=>{const t=e.split("+");if(3===t.length&&""===t[0]){const e=ce(t[1]),n=ce(t[2]);return!i(e)||e>3||!i(n)||n>3?j.err(new ae(ie.RemainingChecks)):j.ok(new U(3-e,3-n))}if(2===t.length){const e=ce(t[0]),n=ce(t[1]);return!i(e)||e>3||!i(n)||n>3?j.err(new ae(ie.RemainingChecks)):j.ok(new U(e,n))}return j.err(new ae(ie.RemainingChecks))},pe=e=>{const t=e.split(/[\s_]+/),s=t.shift();let r,o,a=j.ok(void 0);if(s.endsWith("]")){const e=s.indexOf("[");if(-1===e)return j.err(new ae(ie.Fen));r=le(s.slice(0,e)),a=ue(s.slice(e+1,-1))}else{const e=((e,t,n)=>{let s=e.indexOf(t);for(;n-- >0&&-1!==s;)s=e.indexOf(t,s+t.length);return s})(s,"/",7);-1===e?r=le(s):(r=le(s.slice(0,e)),a=ue(s.slice(e+1)))}const c=t.shift();if(i(c)&&"w"!==c){if("b"!==c)return j.err(new ae(ie.Turn));o="black"}else o="white";return r.chain((e=>{const s=t.shift(),r=i(s)?((e,t)=>{let s=k.empty();if("-"===t)return j.ok(s);for(const n of t){const t=n.toLowerCase(),r=n===t?"black":"white",o=k.backrank(r).intersect(e[r]);let i;if("q"===t)i=o;else if("k"===t)i=o.reversed();else{if(!("a"<=t&&t<="h"))return j.err(new ae(ie.Castling));i=k.fromFile(t.charCodeAt(0)-"a".charCodeAt(0)).intersect(o)}for(const t of i){if(e.king.has(t))break;if(e.rook.has(t)){s=s.with(t);break}}}return n.some((e=>k.backrank(e).intersect(s).size()>2))?j.err(new ae(ie.Castling)):j.ok(s)})(e,s):j.ok(k.empty()),c=t.shift();let h;if(i(c)&&"-"!==c&&(h=d(c),!i(h)))return j.err(new ae(ie.EpSquare));let l,u=t.shift();i(u)&&u.includes("+")&&(l=de(u),u=t.shift());const p=i(u)?ce(u):0;if(!i(p))return j.err(new ae(ie.Halfmoves));const f=t.shift(),m=i(f)?ce(f):1;if(!i(m))return j.err(new ae(ie.Fullmoves));const g=t.shift();let v=j.ok(void 0);if(i(g)){if(i(l))return j.err(new ae(ie.RemainingChecks));v=de(g)}else i(l)&&(v=l);return t.length>0?j.err(new ae(ie.Fen)):a.chain((t=>r.chain((n=>v.map((s=>({board:e,pockets:t,turn:o,unmovedRooks:n,remainingChecks:s,epSquare:h,halfmoves:p,fullmoves:Math.max(1,m)})))))))}))},fe=e=>{let t=l(e.role);return"white"===e.color&&(t=t.toUpperCase()),e.promoted&&(t+="~"),t},me=e=>{let t="",n=0;for(let s=7;s>=0;s--)for(let r=0;r<8;r++){const o=r+8*s,i=e.get(o);i?(n>0&&(t+=n,n=0),t+=fe(i)):n++,7===r&&(n>0&&(t+=n,n=0),0!==s&&(t+="/"))}return t},ge=e=>s.map((t=>l(t).repeat(e[t]))).join(""),ve=(t,s)=>{let r="";for(const o of n){const n=k.backrank(o);let a=t.kingOf(o);i(a)&&!n.has(a)&&(a=void 0);const c=t.pieces(o,"rook").intersect(n);for(const t of s.intersect(c).reversed())if(t===c.first()&&i(a)&&t<a)r+="white"===o?"Q":"q";else if(t===c.last()&&i(a)&&a<t)r+="white"===o?"K":"k";else{const n=e[h(t)];r+="white"===o?n.toUpperCase():n}}return r||"-"},be=(e,t)=>{return[me(e.board)+(e.pockets?`[${s=e.pockets,ge(s.white).toUpperCase()+ge(s.black)}]`:""),e.turn[0],ve(e.board,e.unmovedRooks),i(e.epSquare)?p(e.epSquare):"-",...e.remainingChecks?[(n=e.remainingChecks,`${n.white}+${n.black}`)]:[],...(null==t?void 0:t.epd)?[]:[Math.max(0,Math.min(e.halfmoves,9999)),Math.max(1,Math.min(e.fullmoves,9999))]].join(" ");var n,s},ke=(n,s)=>{var r;const i=((n,s)=>{let r="";if(o(s))"pawn"!==s.role&&(r=l(s.role).toUpperCase()),r+="@"+p(s.to);else{const o=n.board.getRole(s.from);if(!o)return"--";if("king"!==o||!n.board[n.turn].has(s.to)&&2!==Math.abs(s.to-s.from)){const i=n.board.occupied.has(s.to)||"pawn"===o&&h(s.from)!==h(s.to);if("pawn"!==o){let i;if(r=l(o).toUpperCase(),i="king"===o?x(s.to).intersect(n.board.king):"queen"===o?B(s.to,n.board.occupied).intersect(n.board.queen):"rook"===o?T(s.to,n.board.occupied).intersect(n.board.rook):"bishop"===o?N(s.to,n.board.occupied).intersect(n.board.bishop):_(s.to).intersect(n.board.knight),i=i.intersect(n.board[n.turn]).without(s.from),i.nonEmpty()){const o=n.ctx();for(const e of i)n.dests(e,o).has(s.to)||(i=i.without(e));if(i.nonEmpty()){let n=!1,o=i.intersects(k.fromRank(c(s.from)));i.intersects(k.fromFile(h(s.from)))?n=!0:o=!0,o&&(r+=e[h(s.from)]),n&&(r+=t[c(s.from)])}}}else i&&(r=e[h(s.from)]);i&&(r+="x"),r+=p(s.to),s.promotion&&(r+="="+l(s.promotion).toUpperCase())}else r=s.to>s.from?"O-O":"O-O-O"}return r})(n,s);return n.play(s),(null===(r=n.outcome())||void 0===r?void 0:r.winner)?i+"#":n.isCheck()?i+"+":i};class we extends Z{constructor(){super("crazyhouse")}reset(){super.reset(),this.pockets=$.empty()}setupUnchecked(e){super.setupUnchecked(e),this.board.promoted=e.board.promoted.intersect(e.board.occupied).diff(e.board.king).diff(e.board.pawn),this.pockets=e.pockets?e.pockets.clone():$.empty()}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}validate(e){return super.validate(e).chain((e=>{var t,n;return(null===(t=this.pockets)||void 0===t?void 0:t.count("king"))?j.err(new W(H.Kings)):((null===(n=this.pockets)||void 0===n?void 0:n.size())||0)+this.board.occupied.size()>64?j.err(new W(H.Variant)):j.ok(void 0)}))}hasInsufficientMaterial(e){return this.pockets?this.board.occupied.size()+this.pockets.size()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.count("pawn")<=0&&this.pockets.count("rook")<=0&&this.pockets.count("queen")<=0:super.hasInsufficientMaterial(e)}dropDests(e){var t,n;const s=this.board.occupied.complement().intersect((null===(t=this.pockets)||void 0===t?void 0:t[this.turn].hasNonPawns())?k.full():(null===(n=this.pockets)||void 0===n?void 0:n[this.turn].hasPawns())?k.backranks().complement():k.empty());if(e=e||this.ctx(),i(e.king)&&e.checkers.nonEmpty()){const t=e.checkers.singleSquare();return i(t)?s.intersect(z(t,e.king)):k.empty()}return s}}class ye extends Z{constructor(){super("atomic")}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}validate(e){if(this.board.occupied.isEmpty())return j.err(new W(H.Empty));if(this.board.king.size()>2)return j.err(new W(H.Kings));const t=this.board.kingOf(a(this.turn));return i(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?j.err(new W(H.OppositeCheck)):k.backranks().intersects(this.board.pawn)?j.err(new W(H.PawnsOnBackrank)):(null==e?void 0:e.ignoreImpossibleCheck)?j.ok(void 0):this.validateCheckers():j.err(new W(H.Kings))}validateCheckers(){return i(this.epSquare)?j.ok(void 0):super.validateCheckers()}kingAttackers(e,t,n){const s=this.board.pieces(t,"king");return s.isEmpty()||x(e).intersects(s)?k.empty():super.kingAttackers(e,t,n)}playCaptureAt(e,t){super.playCaptureAt(e,t),this.board.take(e);for(const t of x(e).intersect(this.board.occupied).diff(this.board.pawn)){const e=this.board.take(t);"rook"===(null==e?void 0:e.role)&&this.castles.discardRook(t),"king"===(null==e?void 0:e.role)&&this.castles.discardColor(e.color)}}hasInsufficientMaterial(e){if(this.board.pieces(a(e),"king").isEmpty())return!1;if(this.board[e].diff(this.board.king).isEmpty())return!0;if(this.board[a(e)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(k.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(k.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(k.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(k.darkSquares())}return!1}return!this.board.queen.nonEmpty()&&!this.board.pawn.nonEmpty()&&(1===this.board.knight.union(this.board.bishop).union(this.board.rook).size()||!!this.board.occupied.equals(this.board.knight.union(this.board.king))&&this.board.knight.size()<=2)}dests(e,t){t=t||this.ctx();let n=k.empty();for(const s of se(this,e,t)){const t=this.clone();t.play({from:e,to:s});const r=t.board.kingOf(this.turn);!i(r)||i(t.board.kingOf(t.turn))&&!t.kingAttackers(r,t.turn,t.board.occupied).isEmpty()||(n=n.with(s))}return n}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(e){for(const e of n)if(this.board.pieces(e,"king").isEmpty())return{winner:a(e)}}}class Ce extends Z{constructor(){super("antichess")}reset(){super.reset(),this.castles=Y.empty()}setupUnchecked(e){super.setupUnchecked(e),this.castles=Y.empty()}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}validate(e){return this.board.occupied.isEmpty()?j.err(new W(H.Empty)):k.backranks().intersects(this.board.pawn)?j.err(new W(H.PawnsOnBackrank)):j.ok(void 0)}kingAttackers(e,t,n){return k.empty()}ctx(){const e=super.ctx();if(i(this.epSquare)&&q(a(this.turn),this.epSquare).intersects(this.board.pieces(this.turn,"pawn")))return e.mustCapture=!0,e;const t=this.board[a(this.turn)];for(const n of this.board[this.turn])if(se(this,n,e).intersects(t))return e.mustCapture=!0,e;return e}dests(e,t){t=t||this.ctx();const n=se(this,e,t),s=this.board[a(this.turn)];return n.intersect(t.mustCapture?i(this.epSquare)&&"pawn"===this.board.getRole(e)?s.with(this.epSquare):s:k.full())}hasInsufficientMaterial(e){if(this.board[e].isEmpty())return!1;if(this.board[a(e)].isEmpty())return!0;if(this.board.occupied.equals(this.board.bishop)){const t=this.board[e].intersects(k.lightSquares()),n=this.board[e].intersects(k.darkSquares()),s=this.board[a(e)].isDisjoint(k.lightSquares()),r=this.board[a(e)].isDisjoint(k.darkSquares());return t&&s||n&&r}return!(!this.board.occupied.equals(this.board.knight)||2!==this.board.occupied.size())&&this.board.white.intersects(k.lightSquares())!==this.board.black.intersects(k.darkSquares())!=(this.turn===e)}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(e){if((e=e||this.ctx()).variantEnd||this.isStalemate(e))return{winner:this.turn}}}class Se extends Z{constructor(){super("kingofthehill")}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}hasInsufficientMaterial(e){return!1}isVariantEnd(){return this.board.king.intersects(k.center())}variantOutcome(e){for(const e of n)if(this.board.pieces(e,"king").intersects(k.center()))return{winner:e}}}class Ee extends Z{constructor(){super("3check")}reset(){super.reset(),this.remainingChecks=U.default()}setupUnchecked(e){var t;super.setupUnchecked(e),this.remainingChecks=(null===(t=e.remainingChecks)||void 0===t?void 0:t.clone())||U.default()}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}hasInsufficientMaterial(e){return this.board.pieces(e,"king").equals(this.board[e])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(e){if(this.remainingChecks)for(const e of n)if(this.remainingChecks[e]<=0)return{winner:e}}}class xe extends Z{constructor(){super("racingkings")}reset(){this.board=(()=>{const e=D.empty();return e.occupied=new k(65535,0),e.promoted=k.empty(),e.white=new k(61680,0),e.black=new k(3855,0),e.pawn=k.empty(),e.knight=new k(6168,0),e.bishop=new k(9252,0),e.rook=new k(16962,0),e.queen=new k(129,0),e.king=new k(33024,0),e})(),this.pockets=void 0,this.turn="white",this.castles=Y.empty(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(e){super.setupUnchecked(e),this.castles=Y.empty()}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}validate(e){return this.isCheck()||this.board.pawn.nonEmpty()?j.err(new W(H.Variant)):super.validate(e)}dests(e,t){if(e===(t=t||this.ctx()).king)return super.dests(e,t);let n=k.empty();for(const s of super.dests(e,t)){const t={from:e,to:s},r=this.clone();r.play(t),r.isCheck()||(n=n.with(s))}return n}hasInsufficientMaterial(e){return!1}isVariantEnd(){const e=k.fromRank(7),t=this.board.king.intersect(e);if(t.isEmpty())return!1;if("white"===this.turn||t.intersects(this.board.black))return!0;const n=this.board.kingOf("black");if(i(n)){const t=this.board.occupied.without(n);for(const s of x(n).intersect(e).diff(this.board.black))if(this.kingAttackers(s,"white",t).isEmpty())return!1}return!0}variantOutcome(e){if(e?!e.variantEnd:!this.isVariantEnd())return;const t=k.fromRank(7),n=this.board.pieces("black","king").intersects(t),s=this.board.pieces("white","king").intersects(t);return n&&!s?{winner:"black"}:s&&!n?{winner:"white"}:{winner:void 0}}}class _e extends Z{constructor(){super("horde")}reset(){this.board=(()=>{const e=D.empty();return e.occupied=new k(4294967295,4294901862),e.promoted=k.empty(),e.white=new k(4294967295,102),e.black=new k(0,4294901760),e.pawn=new k(4294967295,16711782),e.knight=new k(0,1107296256),e.bishop=new k(0,603979776),e.rook=new k(0,2164260864),e.queen=new k(0,134217728),e.king=new k(0,268435456),e})(),this.pockets=void 0,this.turn="white",this.castles=Y.default(),this.castles.discardColor("white"),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}validate(e){if(this.board.occupied.isEmpty())return j.err(new W(H.Empty));if(1!==this.board.king.size())return j.err(new W(H.Kings));const t=this.board.kingOf(a(this.turn));if(i(t)&&this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty())return j.err(new W(H.OppositeCheck));for(const e of n){const t=this.board.pieces(e,"king").isEmpty()?k.backrank(a(e)):k.backranks();if(this.board.pieces(e,"pawn").intersects(t))return j.err(new W(H.PawnsOnBackrank))}return(null==e?void 0:e.ignoreImpossibleCheck)?j.ok(void 0):this.validateCheckers()}hasInsufficientMaterial(e){return!1}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(e){return this.board.white.isEmpty()?{winner:"black"}:this.board.black.isEmpty()?{winner:"white"}:void 0}}class qe{constructor(){this.children=[]}*mainline(){let e=this;for(;e.children.length;){const t=e.children[0];yield t.data,e=t}}}class Me extends qe{constructor(e){super(),this.data=e}}const Oe=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),Ae=e=>/^\s*$/.test(e),Pe=e=>e.startsWith("%");class Re extends Error{}class Ne{constructor(e,t=Oe,n=1e6){this.emitGame=e,this.initHeaders=t,this.maxBudget=n,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=((e=Oe)=>({headers:e(),moves:new qe}))(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(e){if(this.budget-=e,this.budget<0)throw new Re("ERR_PGN_BUDGET")}parse(e,t){if(!(this.budget<0))try{let n=0;for(;;){const t=e.indexOf("\n",n);if(-1===t)break;const s=t>n&&"\r"===e[t-1]?t-1:t;this.consumeBudget(t-n),this.lineBuf.push(e.slice(n,s)),n=t+1,this.handleLine()}this.consumeBudget(e.length-n),this.lineBuf.push(e.slice(n)),(null==t?void 0:t.stream)||(this.handleLine(),this.emit(void 0))}catch(e){this.emit(e)}}handleLine(){let e=!0,t=this.lineBuf.join("");this.lineBuf=[];e:for(;;)switch(this.state){case 0:t.startsWith("\ufeff")&&(t=t.slice("\ufeff".length)),this.state=1;case 1:if(Ae(t)||Pe(t))return;this.found=!0,this.state=2;case 2:{if(Pe(t))return;let n=!0;for(;n;)n=!1,t=t.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,((t,s,r)=>(this.consumeBudget(200),this.game.headers.set(s,r.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),n=!0,e=!1,"")));if(Ae(t))return;this.state=3}case 3:{if(e){if(Pe(t))return;if(Ae(t))return this.emit(void 0)}const n=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|O-O-O|0-0-0|O-O|0-0)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1-0|0-1|1\/2-1\/2/g;let s;for(;s=n.exec(t);){const e=this.stack[this.stack.length-1];let r=s[0];if(";"===r)return;if(r.startsWith("$"))this.handleNag(parseInt(r.slice(1),10));else if("!"===r)this.handleNag(1);else if("?"===r)this.handleNag(2);else if("!!"===r)this.handleNag(3);else if("??"===r)this.handleNag(4);else if("!?"===r)this.handleNag(5);else if("?!"===r)this.handleNag(6);else if("1-0"===r||"0-1"===r||"1/2-1/2"===r||"*"===r)1===this.stack.length&&"*"!==r&&this.game.headers.set("Result",r);else if("("===r)this.consumeBudget(100),this.stack.push({parent:e.parent,root:!1});else if(")"===r)this.stack.length>1&&this.stack.pop();else{if("{"===r){const e=n.lastIndex,s=" "===t[e]?e+1:e;t=t.slice(s),this.state=4;continue e}this.consumeBudget(100),"Z0"===r||"0000"===r||"@@@@"===r?r="--":r.startsWith("0")&&(r=r.replace(/0/g,"O")),e.node&&(e.parent=e.node),e.node=new Me({san:r,startingComments:e.startingComments}),e.startingComments=void 0,e.root=!1,e.parent.children.push(e.node)}}return}case 4:{const n=t.indexOf("}");if(-1===n)return void this.commentBuf.push(t);{const s=n>0&&" "===t[n-1]?n-1:n;this.commentBuf.push(t.slice(0,s)),this.handleComment(),t=t.slice(n),this.state=3,e=!1}}}}handleNag(e){var t;this.consumeBudget(50);const n=this.stack[this.stack.length-1];n.node&&((t=n.node.data).nags||(t.nags=[]),n.node.data.nags.push(e))}handleComment(){var e,t;this.consumeBudget(100);const n=this.stack[this.stack.length-1],s=this.commentBuf.join("\n");this.commentBuf=[],n.node?((e=n.node.data).comments||(e.comments=[]),n.node.data.comments.push(s)):n.root?((t=this.game).comments||(t.comments=[]),this.game.comments.push(s)):(n.startingComments||(n.startingComments=[]),n.startingComments.push(s))}emit(e){if(4===this.state&&this.handleComment(),e)return this.emitGame(this.game,e);this.found&&this.emitGame(this.game,void 0),this.resetGame()}}const Te=(e,t=Oe)=>{const n=[];return new Ne((e=>n.push(e)),t,NaN).parse(e),n},Be=(e,t)=>{const n=(e=>{switch((e||"chess").toLowerCase()){case"chess":case"chess960":case"chess 960":case"standard":case"from position":case"classical":case"normal":case"fischerandom":case"fischerrandom":case"fischer random":case"wild/0":case"wild/1":case"wild/2":case"wild/3":case"wild/4":case"wild/5":case"wild/6":case"wild/7":case"wild/8":case"wild/8a":return"chess";case"crazyhouse":case"crazy house":case"house":case"zh":return"crazyhouse";case"king of the hill":case"koth":case"kingofthehill":return"kingofthehill";case"three-check":case"three check":case"threecheck":case"three check chess":case"3-check":case"3 check":case"3check":return"3check";case"antichess":case"anti chess":case"anti":return"antichess";case"atomic":case"atom":case"atomic chess":return"atomic";case"horde":case"horde chess":return"horde";case"racing kings":case"racingkings":case"racing":case"race":return"racingkings";default:return}})(e.get("Variant"));if(!n)return j.err(new W(H.Variant));const s=e.get("FEN");return s?pe(s).chain((e=>((e,t,n)=>{switch(e){case"chess":return X.fromSetup(t,n);case"antichess":return Ce.fromSetup(t,n);case"atomic":return ye.fromSetup(t,n);case"horde":return _e.fromSetup(t,n);case"racingkings":return xe.fromSetup(t,n);case"kingofthehill":return Se.fromSetup(t,n);case"3check":return Ee.fromSetup(t,n);case"crazyhouse":return we.fromSetup(t,n)}})(n,e,t))):j.ok((e=>{switch(e){case"chess":return X.default();case"antichess":return Ce.default();case"atomic":return ye.default();case"horde":return _e.default();case"racingkings":return xe.default();case"kingofthehill":return Se.default();case"3check":return Ee.default();case"crazyhouse":return we.default()}})(n))};const Le=e=>{const t=function(e){switch(e){case"G":return"green";case"R":return"red";case"Y":return"yellow";case"B":return"blue";default:return}}(e.slice(0,1)),n=d(e.slice(1,3)),s=d(e.slice(3,5));if(t&&i(n))return 3===e.length?{color:t,from:n,to:n}:5===e.length&&i(s)?{color:t,from:n,to:s}:void 0},Ke=e=>{let t,n,s;const r=[];return{text:e.replace(/\s?\[%(emt|clk)\s(\d{1,5}):(\d{1,2}):(\d{1,2}(?:\.\d{0,3})?)\]\s?/g,((e,s,r,o,i)=>{const a=3600*parseInt(r,10)+60*parseInt(o,10)+parseFloat(i);return"emt"===s?t=a:"clk"===s&&(n=a),"  "})).replace(/\s?\[%(?:csl|cal)\s([RGYB][a-h][1-8](?:[a-h][1-8])?(?:,[RGYB][a-h][1-8](?:[a-h][1-8])?)*)\]\s?/g,((e,t)=>{for(const e of t.split(","))r.push(Le(e));return"  "})).replace(/\s?\[%eval\s(?:#([+-]?\d{1,5})|([+-]?(?:\d{1,5}|\d{0,5}\.\d{1,2})))(?:,(\d{1,5}))?\]\s?/g,((e,t,n,r)=>{const o=r&&parseInt(r,10);return s=t?{mate:parseInt(t,10),depth:o}:{pawns:parseFloat(n),depth:o},"  "})).trim(),shapes:r,emt:t,clock:n,evaluation:s}};const ze=e=>De[e],De={flipTheBoard:"Flip the board",analysisBoard:"Analysis board",practiceWithComputer:"Practice with computer",getPgn:"Get PGN",download:"Download",viewOnLichess:"View on Lichess",viewOnSite:"View on site"},Ie=["white","black"],$e=["a","b","c","d","e","f","g","h"],Ue=["1","2","3","4","5","6","7","8"],Fe=[...Ue].reverse(),Ge=Array.prototype.concat(...$e.map((e=>Ue.map((t=>e+t))))),Ve=e=>Ge[8*e[0]+e[1]],je=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],He=Ge.map(je);const We=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},Qe=e=>"white"===e?"black":"white",Ye=(e,t)=>{const n=e[0]-t[0],s=e[1]-t[1];return n*n+s*s},Ze=(e,t)=>e.role===t.role&&e.color===t.color,Xe=e=>(t,n)=>[(n?t[0]:7-t[0])*e.width/8,(n?7-t[1]:t[1])*e.height/8],Je=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},et=(e,t,n=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${n})`},tt=(e,t)=>{e.style.visibility=t?"visible":"hidden"},nt=e=>{var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},st=e=>2===e.buttons||2===e.button,rt=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function ot(e,t,n){const s=je(e);return t||(s[0]=7-s[0],s[1]=7-s[1]),[n.left+n.width*s[0]/8+n.width/16,n.top+n.height*(7-s[1])/8+n.height/16]}class it{constructor(e){this.path=e,this.size=()=>this.path.length/2,this.head=()=>this.path.slice(0,2),this.tail=()=>new it(this.path.slice(2)),this.init=()=>new it(this.path.slice(0,-2)),this.last=()=>this.path.slice(-2),this.empty=()=>""==this.path,this.contains=e=>this.path.startsWith(e.path),this.isChildOf=e=>this.init()===e,this.append=e=>new it(this.path+e),this.equals=e=>this.path==e.path}}it.root=new it("");class at{constructor(e,t,n,s){this.initial=e,this.moves=t,this.players=n,this.metadata=s,this.nodeAt=e=>ct(this.moves,e),this.dataAt=e=>{const t=this.nodeAt(e);return t?ht(t)?t.data:this.initial:void 0},this.title=()=>this.players.white.name?[this.players.white.title,this.players.white.name,"vs",this.players.black.title,this.players.black.name].filter((e=>e&&!!e.trim())).join("_").replace(" ","-"):"lichess-pgn-viewer",this.pathAtMainlinePly=e=>{var t;return 0==e?it.root:(null===(t=this.mainline[Math.max(0,Math.min(this.mainline.length-1,"last"==e?9999:e-1))])||void 0===t?void 0:t.path)||it.root},this.hasPlayerName=()=>{var e,t;return!(!(null===(e=this.players.white)||void 0===e?void 0:e.name)&&!(null===(t=this.players.black)||void 0===t?void 0:t.name))},this.mainline=Array.from(this.moves.mainline())}}const ct=(e,t)=>{if(t.empty())return e;const n=((e,t)=>e.children.find((e=>e.data.path.last()==t)))(e,t.head());return n?ct(n,t.tail()):void 0},ht=e=>"data"in e;class lt{constructor(e,t,n){this.pos=e,this.path=t,this.clocks=n,this.clone=()=>new lt(this.pos.clone(),this.path,{...this.clocks})}}const ut=e=>{const t=e.map(Ke),n=e=>e.reduce(((e,t)=>null==typeof t?e:t),void 0);return{texts:t.map((e=>e.text)).filter((e=>!!e)),shapes:t.flatMap((e=>e.shapes)),clock:n(t.map((e=>e.clock))),emt:n(t.map((e=>e.emt)))}},dt=(e,t=!1)=>{var n,s;const r=Te(e)[0]||Te("*")[0],o=Be(r.headers).unwrap(),i=be(o.toSetup()),a=ut(r.comments||[]),c=new Map(Array.from(r.headers,(([e,t])=>[e.toLowerCase(),t]))),h=function(e,t){var n;const s=e.get("site"),r=null===(n=e.get("timecontrol"))||void 0===n?void 0:n.split("+").map((e=>parseInt(e))),o=r&&r[0]?{initial:r[0],increment:r[1]||0}:void 0;return{externalLink:s&&s.match(/^https?:\/\//)?s:void 0,isLichess:!(!t||!(null==s?void 0:s.startsWith(t))),timeControl:o}}(c,t),l={fen:i,turn:o.turn,check:o.isCheck(),pos:o.clone(),comments:a.texts,shapes:a.shapes,clocks:{white:(null===(n=h.timeControl)||void 0===n?void 0:n.initial)||a.clock,black:(null===(s=h.timeControl)||void 0===s?void 0:s.initial)||a.clock}},u=pt(o,r.moves,h),d=function(e,t){const n=(t,n)=>{const s=e.get(`${t}${n}`);return"?"==s||""==s?void 0:s},s=e=>{const s=n(e,"");return{name:s,title:n(e,"title"),rating:parseInt(n(e,"elo")||"")||void 0,isLichessUser:t.isLichess&&!!(null==s?void 0:s.match(/^[a-z0-9][a-z0-9_-]{0,28}[a-z0-9]$/i))}};return{white:s("white"),black:s("black")}}(c,h);return new at(l,u,d,h)},pt=(e,t,n)=>((e,t,n)=>{const s=new qe,r=[{before:e,after:s,ctx:t}];let o;for(;o=r.pop();)for(let e=0;e<o.before.children.length;e++){const t=e<o.before.children.length-1?o.ctx.clone():o.ctx,s=o.before.children[e],a=n(t,s.data,e);if(i(a)){const e=new Me(a);o.after.children.push(e),r.push({before:s,after:e,ctx:t})}}return s})(t,new lt(e,it.root,{}),((e,t,s)=>{const r=((e,t)=>{const n=e.ctx(),s=t.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!s){let s;if("O-O"===t||"O-O+"===t||"O-O#"===t?s="h":"O-O-O"!==t&&"O-O-O+"!==t&&"O-O-O#"!==t||(s="a"),s){const t=e.castles.rook[e.turn][s];if(!i(n.king)||!i(t)||!e.dests(n.king,n).has(t))return;return{from:n.king,to:t}}const r=t.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!r)return;const o={role:r[1]?u(r[1]):"pawn",to:d(r[2])};return e.isLegal(o,n)?o:void 0}const r=s[1]?u(s[1]):"pawn",o=d(s[4]),c=s[5]?u(s[5]):void 0;if(!!c!==("pawn"===r&&k.backranks().has(o)))return;if("king"===c&&"antichess"!==e.rules)return;let l=e.board.pieces(e.turn,r);"pawn"!==r||s[2]?s[2]&&(l=l.intersect(k.fromFile(s[2].charCodeAt(0)-"a".charCodeAt(0)))):l=l.intersect(k.fromFile(h(o))),s[3]&&(l=l.intersect(k.fromRank(s[3].charCodeAt(0)-"1".charCodeAt(0))));const p="pawn"===r?k.fromFile(h(o)):k.empty();let f;l=l.intersect(p.union(L({color:a(e.turn),role:r},o,e.board.occupied)));for(const t of l)if(e.dests(t,n).has(o)){if(i(f))return;f=t}return i(f)?{from:f,to:o,promotion:c}:void 0})(e.pos,t.san);if(!r)return;const c=(e=>o(e)?String.fromCharCode(35+e.to,139+["queen","rook","bishop","knight","pawn"].indexOf(e.role)):String.fromCharCode(35+e.from,e.promotion?99+8*["queen","rook","bishop","knight","king"].indexOf(e.promotion)+h(e.to):35+e.to))(r),l=e.path.append(c),p=ke(e.pos,r);e.path=l;const m=e.pos.toSetup(),g=ut(t.comments||[]),v=ut(t.startingComments||[]),b=[...g.shapes,...v.shapes],w=2*(m.fullmoves-1)+("white"===e.pos.turn?0:1);let y=e.clocks=ft(e.clocks,e.pos.turn,g.clock);w<2&&n.timeControl&&(y={white:n.timeControl.initial,black:n.timeControl.initial,...y});return{path:l,ply:w,move:r,san:p,uci:f(r),fen:be(e.pos.toSetup()),turn:e.pos.turn,check:e.pos.isCheck(),comments:g.texts,startingComments:v.texts,nags:t.nags||[],shapes:b,clocks:y,emt:g.emt}})),ft=(e,t,n)=>"white"==t?{...e,black:n}:{...e,white:n};class mt{constructor(e,t){var n;this.opts=e,this.redraw=t,this.flipped=!1,this.pane="board",this.autoScrollRequested=!1,this.curNode=()=>this.game.nodeAt(this.path)||this.game.moves,this.curData=()=>this.game.dataAt(this.path)||this.game.initial,this.goTo=(e,t=!0)=>{var n,s;const r="first"==e?it.root:"prev"==e?this.path.init():"next"==e?null===(s=null===(n=this.game.nodeAt(this.path))||void 0===n?void 0:n.children[0])||void 0===s?void 0:s.data.path:this.game.pathAtMainlinePly("last");this.toPath(r||this.path,t)},this.canGoTo=e=>"prev"==e||"first"==e?!this.path.empty():!!this.curNode().children[0],this.toPath=(e,t=!0)=>{this.path=e,this.pane="board",this.autoScrollRequested=!0,this.redrawGround(),this.redraw(),t&&this.focus()},this.focus=()=>{var e;return null===(e=this.div)||void 0===e?void 0:e.focus()},this.toggleMenu=()=>{this.pane="board"==this.pane?"menu":"board",this.redraw()},this.togglePgn=()=>{this.pane="pgn"==this.pane?"board":"pgn",this.redraw()},this.orientation=()=>{const e=this.opts.orientation||"white";return this.flipped?a(e):e},this.flip=()=>{this.flipped=!this.flipped,this.pane="board",this.redrawGround(),this.redraw()},this.cgState=()=>{var e;const t=this.curData(),n="uci"in t?(e=>{if(e)return"@"===e[1]?[e.slice(2,4)]:[e.slice(0,2),e.slice(2,4)]})(t.uci):null===(e=this.opts.chessground)||void 0===e?void 0:e.lastMove;return{fen:this.curData().fen,orientation:this.orientation(),check:this.curData().check,lastMove:n,turnColor:t.turn}},this.analysisUrl=()=>this.game.metadata.isLichess&&this.game.metadata.externalLink||`https://lichess.org/analysis/${this.curData().fen.replace(" ","_")}?color=${this.orientation()}`,this.practiceUrl=()=>`${this.analysisUrl()}#practice`,this.setGround=e=>{this.ground=e,this.redrawGround()},this.redrawGround=()=>this.withGround((e=>{e.set(this.cgState()),e.setShapes(this.curData().shapes.map((e=>({orig:p(e.from),dest:p(e.to),brush:e.color}))))})),this.withGround=e=>this.ground&&e(this.ground),this.game=dt(e.pgn,e.lichess),this.translate=(n=e.translate,e=>n&&n(e)||ze(e)),this.path=this.game.pathAtMainlinePly(e.initialPly)}}const gt=(e,t)=>Math.abs(e-t),vt=(e,t,n,s)=>{const r=gt(e,n),o=gt(t,s);return 1===r&&2===o||2===r&&1===o},bt=(e,t,n,s)=>gt(e,n)===gt(t,s),kt=(e,t,n,s)=>e===n||t===s,wt=(e,t,n,s)=>bt(e,t,n,s)||kt(e,t,n,s);function yt(e,t,n){const s=e.get(t);if(!s)return[];const r=je(t),o=s.role,i="pawn"===o?(a=s.color,(e,t,n,s)=>gt(e,n)<2&&("white"===a?s===t+1||t<=1&&s===t+2&&e===n:s===t-1||t>=6&&s===t-2&&e===n)):"knight"===o?vt:"bishop"===o?bt:"rook"===o?kt:"queen"===o?wt:((e,t,n)=>(s,r,o,i)=>gt(s,o)<2&&gt(r,i)<2||n&&r===i&&r===("white"===e?0:7)&&(4===s&&(2===o&&t.includes(0)||6===o&&t.includes(7))||t.includes(o)))(s.color,function(e,t){const n="white"===t?"1":"8",s=[];for(const[r,o]of e)r[1]===n&&o.color===t&&"rook"===o.role&&s.push(je(r)[0]);return s}(e,s.color),n);var a;return He.filter((e=>(r[0]!==e[0]||r[1]!==e[1])&&i(r[0],r[1],e[0],e[1]))).map(Ve)}function Ct(e,...t){e&&setTimeout((()=>e(...t)),1)}function St(e){e.premovable.current&&(e.premovable.current=void 0,Ct(e.premovable.events.unset))}function Et(e){const t=e.predroppable;t.current&&(t.current=void 0,Ct(t.events.unset))}function xt(e,t,n){const s=e.pieces.get(t),r=e.pieces.get(n);if(t===n||!s)return!1;const o=r&&r.color!==s.color?r:void 0;return n===e.selected&&Rt(e),Ct(e.events.move,t,n,o),function(e,t,n){if(!e.autoCastle)return!1;const s=e.pieces.get(t);if(!s||"king"!==s.role)return!1;const r=je(t),o=je(n);if(0!==r[1]&&7!==r[1]||r[1]!==o[1])return!1;4!==r[0]||e.pieces.has(n)||(6===o[0]?n=Ve([7,o[1]]):2===o[0]&&(n=Ve([0,o[1]])));const i=e.pieces.get(n);return!(!i||i.color!==s.color||"rook"!==i.role||(e.pieces.delete(t),e.pieces.delete(n),r[0]<o[0]?(e.pieces.set(Ve([6,o[1]]),s),e.pieces.set(Ve([5,o[1]]),i)):(e.pieces.set(Ve([2,o[1]]),s),e.pieces.set(Ve([3,o[1]]),i)),0))}(e,t,n)||(e.pieces.set(n,s),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,Ct(e.events.change),o||!0}function _t(e,t,n,s){if(e.pieces.has(n)){if(!s)return!1;e.pieces.delete(n)}return Ct(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,Ct(e.events.change),e.movable.dests=void 0,e.turnColor=Qe(e.turnColor),!0}function qt(e,t,n){const s=xt(e,t,n);return s&&(e.movable.dests=void 0,e.turnColor=Qe(e.turnColor),e.animation.current=void 0),s}function Mt(e,t,n){if(Tt(e,t,n)){const s=qt(e,t,n);if(s){const r=e.hold.stop();Rt(e);const o={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==s&&(o.captured=s),Ct(e.movable.events.after,t,n,o),!0}}else if(Lt(e,t,n))return function(e,t,n,s){Et(e),e.premovable.current=[t,n],Ct(e.premovable.events.set,t,n,s)}(e,t,n,{ctrlKey:e.stats.ctrlKey}),Rt(e),!0;return Rt(e),!1}function Ot(e,t,n,s){const r=e.pieces.get(t);r&&(function(e,t,n){const s=e.pieces.get(t);return!(!s||t!==n&&e.pieces.has(n)||"both"!==e.movable.color&&(e.movable.color!==s.color||e.turnColor!==s.color))}(e,t,n)||s)?(e.pieces.delete(t),_t(e,r,n,s),Ct(e.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&function(e,t,n){const s=e.pieces.get(t),r=e.pieces.get(n);return!!s&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&("pawn"!==s.role||"1"!==n[1]&&"8"!==n[1])&&e.movable.color===s.color&&e.turnColor!==s.color}(e,t,n)?function(e,t,n){St(e),e.predroppable.current={role:t,key:n},Ct(e.predroppable.events.set,t,n)}(e,r.role,n):(St(e),Et(e)),e.pieces.delete(t),Rt(e)}function At(e,t,n){if(Ct(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return Rt(e),void e.hold.cancel();if((e.selectable.enabled||n)&&e.selected!==t&&Mt(e,e.selected,t))return void(e.stats.dragged=!1)}(e.selectable.enabled||e.draggable.enabled)&&(Nt(e,t)||Bt(e,t))&&(Pt(e,t),e.hold.start())}function Pt(e,t){e.selected=t,Bt(e,t)?e.premovable.dests=yt(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function Rt(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function Nt(e,t){const n=e.pieces.get(t);return!!n&&("both"===e.movable.color||e.movable.color===n.color&&e.turnColor===n.color)}const Tt=(e,t,n)=>{var s,r;return t!==n&&Nt(e,t)&&(e.movable.free||!!(null===(r=null===(s=e.movable.dests)||void 0===s?void 0:s.get(t))||void 0===r?void 0:r.includes(n)))};function Bt(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}const Lt=(e,t,n)=>t!==n&&Bt(e,t)&&yt(e.pieces,t,e.premovable.castle).includes(n);function Kt(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],s=t[1];let r=!1;if(Tt(e,n,s)){const t=qt(e,n,s);if(t){const o={premove:!0};!0!==t&&(o.captured=t),Ct(e.movable.events.after,n,s,o),r=!0}}return St(e),r}function zt(e){St(e),Et(e),Rt(e)}function Dt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,zt(e)}function It(e,t,n){let s=Math.floor(8*(e[0]-n.left)/n.width);t||(s=7-s);let r=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(r=7-r),s>=0&&s<8&&r>=0&&r<8?Ve([s,r]):void 0}const $t=e=>"white"===e.orientation,Ut="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Ft={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Gt={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Vt(e){"start"===e&&(e=Ut);const t=new Map;let n=7,s=0;for(const r of e)switch(r){case" ":case"[":return t;case"/":if(--n,n<0)return t;s=0;break;case"~":{const e=t.get(Ve([s-1,n]));e&&(e.promoted=!0);break}default:{const e=r.charCodeAt(0);if(e<57)s+=e-48;else{const e=r.toLowerCase();t.set(Ve([s,n]),{role:Ft[e],color:r===e?"black":"white"}),++s}}}return t}function jt(e,t){t.animation&&(Wt(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function Ht(e,t){var n,s,r;if((null===(n=t.movable)||void 0===n?void 0:n.dests)&&(e.movable.dests=void 0),(null===(s=t.drawable)||void 0===s?void 0:s.autoShapes)&&(e.drawable.autoShapes=[]),Wt(e,t),t.fen&&(e.pieces=Vt(t.fen),e.drawable.shapes=(null===(r=t.drawable)||void 0===r?void 0:r.shapes)||[]),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[n,s]of e.pieces)"king"===s.role&&s.color===t&&(e.check=n)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&Pt(e,e.selected),jt(e,t),!e.movable.rookCastle&&e.movable.dests){const t="white"===e.movable.color?"1":"8",n="e"+t,s=e.movable.dests.get(n),r=e.pieces.get(n);if(!s||!r||"king"!==r.role)return;e.movable.dests.set(n,s.filter((e=>!(e==="a"+t&&s.includes("c"+t)||e==="h"+t&&s.includes("g"+t)))))}}function Wt(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(Object.prototype.hasOwnProperty.call(e,n)&&Qt(e[n])&&Qt(t[n])?Wt(e[n],t[n]):e[n]=t[n])}function Qt(e){if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||null===t}const Yt=(e,t)=>t.animation.enabled?function(e,t){const n=new Map(t.pieces),s=e(t),r=function(e,t){const n=new Map,s=[],r=new Map,o=[],i=[],a=new Map;let c,h,l;for(const[t,n]of e)a.set(t,Xt(t,n));for(const e of Ge)c=t.pieces.get(e),h=a.get(e),c?h?Ze(c,h.piece)||(o.push(h),i.push(Xt(e,c))):i.push(Xt(e,c)):h&&o.push(h);for(const e of i)h=Jt(e,o.filter((t=>Ze(e.piece,t.piece)))),h&&(l=[h.pos[0]-e.pos[0],h.pos[1]-e.pos[1]],n.set(e.key,l.concat(l)),s.push(h.key));for(const e of o)s.includes(e.key)||r.set(e.key,e.piece);return{anims:n,fadings:r}}(n,t);if(r.anims.size||r.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:r},e||en(t,performance.now())}else t.dom.redraw();return s}(e,t):Zt(e,t);function Zt(e,t){const n=e(t);return t.dom.redraw(),n}const Xt=(e,t)=>({key:e,pos:je(e),piece:t}),Jt=(e,t)=>t.sort(((t,n)=>Ye(e.pos,t.pos)-Ye(e.pos,n.pos)))[0];function en(e,t){const n=e.animation.current;if(void 0===n)return void(e.dom.destroyed||e.dom.redrawNow());const s=1-(t-n.start)*n.frequency;if(s<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=tn(s);for(const e of n.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;e.dom.redrawNow(!0),requestAnimationFrame(((t=performance.now())=>en(e,t)))}}const tn=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,nn=["green","red","blue","yellow"];function sn(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?Rt(e):zt(e);const n=nt(t),s=It(n,$t(e),e.dom.bounds());s&&(e.drawable.current={orig:s,pos:n,brush:hn(t),snapToValidMove:e.drawable.defaultSnapToValidMove},rn(e))}function rn(e){requestAnimationFrame((()=>{const t=e.drawable.current;if(t){const n=It(t.pos,$t(e),e.dom.bounds());n||(t.snapToValidMove=!1);const s=t.snapToValidMove?function(e,t,n,s){const r=je(e),o=He.filter((e=>wt(r[0],r[1],e[0],e[1])||vt(r[0],r[1],e[0],e[1]))),i=o.map((e=>ot(Ve(e),n,s))).map((e=>Ye(t,e))),[,a]=i.reduce(((e,t,n)=>e[0]<t?e:[t,n]),[i[0],0]);return Ve(o[a])}(t.orig,t.pos,$t(e),e.dom.bounds()):n;s!==t.mouseSq&&(t.mouseSq=s,t.dest=s!==t.orig?s:void 0,e.dom.redrawNow()),rn(e)}}))}function on(e,t){e.drawable.current&&(e.drawable.current.pos=nt(t))}function an(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const n=e=>e.orig===t.orig&&e.dest===t.dest,s=e.shapes.find(n);s&&(e.shapes=e.shapes.filter((e=>!n(e))));s&&s.brush===t.brush||e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush});ln(e)}(e.drawable,t),cn(e))}function cn(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function hn(e){var t;const n=(e.shiftKey||e.ctrlKey)&&st(e),s=e.altKey||e.metaKey||(null===(t=e.getModifierState)||void 0===t?void 0:t.call(e,"AltGraph"));return nn[(n?1:0)+(s?2:0)]}function ln(e){e.onChange&&e.onChange(e.shapes)}function un(e,t){if(!t.isTrusted||void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),s=nt(t),r=It(s,$t(e),n);if(!r)return;const o=e.pieces.get(r),i=e.selected;var a;i||!e.drawable.enabled||!e.drawable.eraseOnClick&&o&&o.color===e.turnColor||(a=e).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),ln(a.drawable)),!1!==t.cancelable&&(!t.touches||e.blockTouchScroll||o||i||function(e,t){const n=$t(e),s=e.dom.bounds(),r=Math.pow(s.width/8,2);for(const o of e.pieces.keys()){const e=ot(o,n,s);if(Ye(e,t)<=r)return!0}return!1}(e,s))&&t.preventDefault();const c=!!e.premovable.current,h=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&Tt(e,e.selected,r)?Yt((e=>At(e,r)),e):At(e,r);const l=e.selected===r,u=vn(e,r);if(o&&u&&l&&function(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}(e,r)){e.draggable.current={orig:r,piece:o,origPos:s,pos:s,started:e.draggable.autoDistance&&e.stats.dragged,element:u,previouslySelected:i,originTarget:t.target,keyHasChanged:!1},u.cgDragging=!0,u.classList.add("dragging");const a=e.dom.elements.ghost;a&&(a.className=`ghost ${o.color} ${o.role}`,Je(a,Xe(n)(je(r),$t(e))),tt(a,!0)),dn(e)}else c&&St(e),h&&Et(e);e.dom.redraw()}function dn(e){requestAnimationFrame((()=>{var t;const n=e.draggable.current;if(!n)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(n.orig))&&(e.animation.current=void 0);const s=e.pieces.get(n.orig);if(s&&Ze(s,n.piece)){if(!n.started&&Ye(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if("function"==typeof n.element){const e=n.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),n.element=e}const t=e.dom.bounds();Je(n.element,[n.pos[0]-t.left-t.width/16,n.pos[1]-t.top-t.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==It(n.pos,$t(e),t))}}else mn(e);dn(e)}))}function pn(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=nt(t))}function fn(e,t){const n=e.draggable.current;if(!n)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&n.originTarget!==t.target&&!n.newPiece)return void(e.draggable.current=void 0);St(e),Et(e);const s=It(nt(t)||n.pos,$t(e),e.dom.bounds());s&&n.started&&n.orig!==s?n.newPiece?Ot(e,n.orig,s,n.force):(e.stats.ctrlKey=t.ctrlKey,Mt(e,n.orig,s)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!s&&(e.pieces.delete(n.orig),Ct(e.events.change)),(n.orig!==n.previouslySelected&&!n.keyHasChanged||n.orig!==s&&s)&&e.selectable.enabled||Rt(e),gn(e),e.draggable.current=void 0,e.dom.redraw()}function mn(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,Rt(e),gn(e),e.dom.redraw())}function gn(e){const t=e.dom.elements;t.ghost&&tt(t.ghost,!1)}function vn(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&"PIECE"===n.tagName)return n;n=n.nextSibling}}function bn(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function kn(e,t){function n(){!function(e){e.orientation=Qe(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),t()}return{set(t){t.orientation&&t.orientation!==e.orientation&&n(),jt(e,t),(t.fen?Yt:Zt)((e=>Ht(e,t)),e)},state:e,getFen:()=>{return t=e.pieces,Fe.map((e=>$e.map((n=>{const s=t.get(n+e);if(s){let e=Gt[s.role];return"white"===s.color&&(e=e.toUpperCase()),s.promoted&&(e+="~"),e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()));var t},toggleOrientation:n,setPieces(t){Yt((e=>function(e,t){for(const[n,s]of t)s?e.pieces.set(n,s):e.pieces.delete(n)}(e,t)),e)},selectSquare(t,n){t?Yt((e=>At(e,t,n)),e):e.selected&&(Rt(e),e.dom.redraw())},move(t,n){Yt((e=>xt(e,t,n)),e)},newPiece(t,n){Yt((e=>_t(e,t,n)),e)},playPremove(){if(e.premovable.current){if(Yt(Kt,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const n=function(e,t){const n=e.predroppable.current;let s=!1;if(!n)return!1;t(n)&&_t(e,{role:n.role,color:e.movable.color},n.key)&&(Ct(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),s=!0);return Et(e),s}(e,t);return e.dom.redraw(),n}return!1},cancelPremove(){Zt(St,e)},cancelPredrop(){Zt(Et,e)},cancelMove(){Zt((e=>{zt(e),mn(e)}),e)},stop(){Zt((e=>{Dt(e),mn(e)}),e)},explode(t){!function(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout((()=>{bn(e,2),setTimeout((()=>bn(e,void 0)),120)}),120)}(e,t)},setAutoShapes(t){Zt((e=>e.drawable.autoShapes=t),e)},setShapes(t){Zt((e=>e.drawable.shapes=t),e)},getKeyAtDomPos:t=>It(t,$t(e),e.dom.bounds()),redrawAll:t,dragNewPiece(t,n,s){!function(e,t,n,s){const r="a0";e.pieces.set(r,t),e.dom.redraw();const o=nt(n);e.draggable.current={orig:r,piece:t,origPos:o,pos:o,started:!0,element:()=>vn(e,r),originTarget:n.target,newPiece:!0,force:!!s,keyHasChanged:!1},dn(e)}(e,t,n,s)},destroy(){Dt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function wn(e,t,n){const s=new Map,r=[];for(const t of e)s.set(t.hash,!1);let o,i=t.firstChild;for(;i;)o=i.getAttribute("cgHash"),s.has(o)?s.set(o,!0):r.push(i),i=i.nextSibling;for(const e of r)t.removeChild(e);for(const r of e)s.get(r.hash)||t.appendChild(n(r))}function yn(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Cn(e,t,n){const s=e.drawable,r=s.current,o=r&&r.mouseSq?r:void 0,i=new Map,a=e.dom.bounds(),c=s.autoShapes.filter((e=>!e.piece));for(const e of s.shapes.concat(c).concat(o?[o]:[]))e.dest&&i.set(e.dest,(i.get(e.dest)||0)+1);const h=s.shapes.concat(c).map((e=>({shape:e,current:!1,hash:Sn(e,i,!1,a)})));o&&h.push({shape:o,current:!0,hash:Sn(o,i,!0,a)});const l=h.map((e=>e.hash)).join(";");if(l===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=l;const u=t.querySelector("defs"),d=t.querySelector("g"),p=n.querySelector("g");!function(e,t,n){const s=new Map;let r;for(const n of t)n.shape.dest&&(r=e.brushes[n.shape.brush],n.shape.modifiers&&(r=An(r,n.shape.modifiers)),s.set(r.key,r));const o=new Set;let i=n.firstChild;for(;i;)o.add(i.getAttribute("cgKey")),i=i.nextSibling;for(const[e,t]of s.entries())o.has(e)||n.appendChild(qn(t))}(s,h,u),wn(h.filter((e=>!e.shape.customSvg)),d,(t=>_n(e,t,s.brushes,i,a))),wn(h.filter((e=>e.shape.customSvg)),p,(t=>_n(e,t,s.brushes,i,a)))}function Sn({orig:e,dest:t,brush:n,piece:s,modifiers:r,customSvg:o},i,a,c){return[c.width,c.height,a,e,t,n,t&&(i.get(t)||0)>1,s&&En(s),r&&(h=r,""+(h.lineWidth||"")),o&&xn(o)].filter((e=>e)).join(",");var h}function En(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function xn(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return"custom-"+t.toString()}function _n(e,{shape:t,current:n,hash:s},r,o,i){let a;const c=On(je(t.orig),e.orientation);if(t.customSvg)a=function(e,t,n){const[s,r]=Nn(t,n),o=Mn(yn("g"),{transform:`translate(${s},${r})`}),i=Mn(yn("svg"),{width:1,height:1,viewBox:"0 0 100 100"});return o.appendChild(i),i.innerHTML=e,o}(t.customSvg,c,i);else if(t.dest){let s=r[t.brush];t.modifiers&&(s=An(s,t.modifiers)),a=function(e,t,n,s,r,o){const i=function(e){return(e?20:10)/64}(r&&!s),a=Nn(t,o),c=Nn(n,o),h=c[0]-a[0],l=c[1]-a[1],u=Math.atan2(l,h),d=Math.cos(u)*i,p=Math.sin(u)*i;return Mn(yn("line"),{stroke:e.color,"stroke-width":Pn(e,s),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:Rn(e,s),x1:a[0],y1:a[1],x2:c[0]-d,y2:c[1]-p})}(s,c,On(je(t.dest),e.orientation),n,(o.get(t.dest)||0)>1,i)}else a=function(e,t,n,s){const r=Nn(t,s),o=[3/64,4/64],i=(s.width+s.height)/(4*Math.max(s.width,s.height));return Mn(yn("circle"),{stroke:e.color,"stroke-width":o[n?0:1],fill:"none",opacity:Rn(e,n),cx:r[0],cy:r[1],r:i-o[1]/2})}(r[t.brush],c,n,i);return a.setAttribute("cgHash",s),a}function qn(e){const t=Mn(yn("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(Mn(yn("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function Mn(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.setAttribute(n,t[n]);return e}function On(e,t){return"white"===t?e:[7-e[0],7-e[1]]}function An(e,t){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter((e=>e)).join("")}}function Pn(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function Rn(e,t){return(e.opacity||1)*(t?.9:1)}function Nn(e,t){const n=Math.min(1,t.width/t.height),s=Math.min(1,t.height/t.width);return[(e[0]-3.5)*n,(3.5-e[1])*s]}function Tn(e,t){const n=rt("coords",t);let s;for(const t of e)s=rt("coord"),s.textContent=t,n.appendChild(s);return n}function Bn(e,t,n,s){return e.addEventListener(t,n,s),()=>e.removeEventListener(t,n,s)}const Ln=e=>t=>{e.draggable.current?mn(e):e.drawable.current?cn(e):t.shiftKey||st(t)?e.drawable.enabled&&sn(e,t):e.viewOnly||(e.dropmode.active?function(e,t){if(!e.dropmode.active)return;St(e),Et(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const s=nt(t),r=s&&It(s,$t(e),e.dom.bounds());r&&Ot(e,"a0",r)}e.dom.redraw()}(e,t):un(e,t))},Kn=(e,t,n)=>s=>{e.drawable.current?e.drawable.enabled&&n(e,s):e.viewOnly||t(e,s)};function zn(e){const t=$t(e),n=Xe(e.dom.bounds()),s=e.dom.elements.board,r=e.pieces,o=e.animation.current,i=o?o.plan.anims:new Map,a=o?o.plan.fadings:new Map,c=e.draggable.current,h=function(e){var t;const n=new Map;if(e.lastMove&&e.highlight.lastMove)for(const t of e.lastMove)Vn(n,t,"last-move");e.check&&e.highlight.check&&Vn(n,e.check,"check");if(e.selected&&(Vn(n,e.selected,"selected"),e.movable.showDests)){const s=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(s)for(const t of s)Vn(n,t,"move-dest"+(e.pieces.has(t)?" oc":""));const r=e.premovable.dests;if(r)for(const t of r)Vn(n,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}const s=e.premovable.current;if(s)for(const e of s)Vn(n,e,"current-premove");else e.predroppable.current&&Vn(n,e.predroppable.current.key,"current-premove");const r=e.exploding;if(r)for(const e of r.keys)Vn(n,e,"exploding"+r.stage);return n}(e),l=new Set,u=new Set,d=new Map,p=new Map;let f,m,g,v,b,k,w,y,C,S;for(m=s.firstChild;m;){if(f=m.cgKey,In(m))if(g=r.get(f),b=i.get(f),k=a.get(f),v=m.cgPiece,!m.cgDragging||c&&c.orig===f||(m.classList.remove("dragging"),Je(m,n(je(f),t)),m.cgDragging=!1),!k&&m.cgFading&&(m.cgFading=!1,m.classList.remove("fading")),g){if(b&&m.cgAnimating&&v===Gn(g)){const e=je(f);e[0]+=b[2],e[1]+=b[3],m.classList.add("anim"),Je(m,n(e,t))}else m.cgAnimating&&(m.cgAnimating=!1,m.classList.remove("anim"),Je(m,n(je(f),t)),e.addPieceZIndex&&(m.style.zIndex=Fn(je(f),t)));v!==Gn(g)||k&&m.cgFading?k&&v===Gn(k)?(m.classList.add("fading"),m.cgFading=!0):jn(d,v,m):l.add(f)}else jn(d,v,m);else if($n(m)){const e=m.className;h.get(f)===e?u.add(f):jn(p,e,m)}m=m.nextSibling}for(const[e,r]of h)if(!u.has(e)){C=p.get(r),S=C&&C.pop();const o=n(je(e),t);if(S)S.cgKey=e,Je(S,o);else{const t=rt("square",r);t.cgKey=e,Je(t,o),s.insertBefore(t,s.firstChild)}}for(const[o,a]of r)if(b=i.get(o),!l.has(o))if(w=d.get(Gn(a)),y=w&&w.pop(),y){y.cgKey=o,y.cgFading&&(y.classList.remove("fading"),y.cgFading=!1);const s=je(o);e.addPieceZIndex&&(y.style.zIndex=Fn(s,t)),b&&(y.cgAnimating=!0,y.classList.add("anim"),s[0]+=b[2],s[1]+=b[3]),Je(y,n(s,t))}else{const r=Gn(a),i=rt("piece",r),c=je(o);i.cgPiece=r,i.cgKey=o,b&&(i.cgAnimating=!0,c[0]+=b[2],c[1]+=b[3]),Je(i,n(c,t)),e.addPieceZIndex&&(i.style.zIndex=Fn(c,t)),s.appendChild(i)}for(const t of d.values())Un(e,t);for(const t of p.values())Un(e,t)}function Dn(e){var t,n;const s=e.dom.elements.wrap.getBoundingClientRect(),r=e.dom.elements.container,o=s.height/s.width,i=8*Math.floor(s.width*window.devicePixelRatio/8)/window.devicePixelRatio,a=i*o;r.style.width=i+"px",r.style.height=a+"px",e.dom.bounds.clear(),null===(t=e.addDimensionsCssVarsTo)||void 0===t||t.style.setProperty("--cg-width",i+"px"),null===(n=e.addDimensionsCssVarsTo)||void 0===n||n.style.setProperty("--cg-height",a+"px")}const In=e=>"PIECE"===e.tagName,$n=e=>"SQUARE"===e.tagName;function Un(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function Fn(e,t){const n=e[1];return`${t?10-n:3+n}`}const Gn=e=>`${e.color} ${e.role}`;function Vn(e,t,n){const s=e.get(t);s?e.set(t,`${s} ${n}`):e.set(t,n)}function jn(e,t,n){const s=e.get(t);s?s.push(n):e.set(t,[n])}function Hn(e,t){wn(e.drawable.autoShapes.filter((e=>e.piece)).map((e=>({shape:e,hash:Wn(e),current:!1}))),t,(t=>function(e,{shape:t,hash:n},s){var r,o,i;const a=t.orig,c=null===(r=t.piece)||void 0===r?void 0:r.role,h=null===(o=t.piece)||void 0===o?void 0:o.color,l=null===(i=t.piece)||void 0===i?void 0:i.scale,u=rt("piece",`${c} ${h}`);return u.setAttribute("cgHash",n),u.cgKey=a,u.cgScale=l,et(u,Xe(s)(je(a),$t(e)),l),u}(e,t,e.dom.bounds())))}const Wn=e=>{var t,n,s;return[e.orig,null===(t=e.piece)||void 0===t?void 0:t.role,null===(n=e.piece)||void 0===n?void 0:n.color,null===(s=e.piece)||void 0===s?void 0:s.scale].join(",")};function Qn(e,t){const n={pieces:Vt(Ut),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:We()};function s(){const t="dom"in n?n.dom.unbind:void 0,s=function(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const n of Ie)e.classList.toggle("orientation-"+n,t.orientation===n);e.classList.toggle("manipulable",!t.viewOnly);const n=rt("cg-container");e.appendChild(n);const s=rt("cg-board");let r,o,i,a;if(n.appendChild(s),t.drawable.visible&&(r=Mn(yn("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(yn("defs")),r.appendChild(yn("g")),o=Mn(yn("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild(yn("g")),i=rt("cg-auto-pieces"),n.appendChild(r),n.appendChild(o),n.appendChild(i)),t.coordinates){const e="black"===t.orientation?" black":"",s="left"===t.ranksPosition?" left":"";n.appendChild(Tn(Ue,"ranks"+e+s)),n.appendChild(Tn($e,"files"+e))}return t.draggable.enabled&&t.draggable.showGhost&&(a=rt("piece","ghost"),tt(a,!1),n.appendChild(a)),{board:s,container:n,wrap:e,ghost:a,svg:r,customSvg:o,autoPieces:i}}(e,n),r=function(e){let t;const n=()=>(void 0===t&&(t=e()),t);return n.clear=()=>{t=void 0},n}((()=>s.board.getBoundingClientRect())),o=e=>{zn(a),s.autoPieces&&Hn(a,s.autoPieces),!e&&s.svg&&Cn(a,s.svg,s.customSvg)},i=()=>{Dn(a),function(e){const t=$t(e),n=Xe(e.dom.bounds());let s=e.dom.elements.board.firstChild;for(;s;)(In(s)&&!s.cgAnimating||$n(s))&&Je(s,n(je(s.cgKey),t)),s=s.nextSibling}(a),s.autoPieces&&function(e){var t;const n=$t(e),s=Xe(e.dom.bounds());let r=null===(t=e.dom.elements.autoPieces)||void 0===t?void 0:t.firstChild;for(;r;)et(r,s(je(r.cgKey),n),r.cgScale),r=r.nextSibling}(a)},a=n;return a.dom={elements:s,bounds:r,redraw:Yn(o),redrawNow:o,unbind:t},a.drawable.prevSvgHash="",Dn(a),o(!1),function(e,t){const n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",(e=>e.preventDefault())),e.viewOnly)return;const s=Ln(e);n.addEventListener("touchstart",s,{passive:!1}),n.addEventListener("mousedown",s,{passive:!1})}(a,i),t||(a.dom.unbind=function(e,t){const n=[];if("ResizeObserver"in window||n.push(Bn(document.body,"chessground.resize",t)),!e.viewOnly){const t=Kn(e,pn,on),s=Kn(e,fn,an);for(const e of["touchmove","mousemove"])n.push(Bn(document,e,t));for(const e of["touchend","mouseup"])n.push(Bn(document,e,s));const r=()=>e.dom.bounds.clear();n.push(Bn(document,"scroll",r,{capture:!0,passive:!0})),n.push(Bn(window,"resize",r,{passive:!0}))}return()=>n.forEach((e=>e()))}(a,i)),a.events.insert&&a.events.insert(s),a}return Ht(n,t||{}),kn(s(),s)}function Yn(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame((()=>{e(),t=!1})))}}function Zn(e){if(Xn(e)){for(;e&&Xn(e);){e=Jn(e).parent}return null!=e?e:null}return e.parentNode}function Xn(e){return 11===e.nodeType}function Jn(e,t){var n,s,r;const o=e;return null!==(n=o.parent)&&void 0!==n||(o.parent=null!=t?t:null),null!==(s=o.firstChildNode)&&void 0!==s||(o.firstChildNode=e.firstChild),null!==(r=o.lastChildNode)&&void 0!==r||(o.lastChildNode=e.lastChild),o}const es={createElement:function(e,t){return document.createElement(e,t)},createElementNS:function(e,t,n){return document.createElementNS(e,t,n)},createTextNode:function(e){return document.createTextNode(e)},createDocumentFragment:function(){return Jn(document.createDocumentFragment())},createComment:function(e){return document.createComment(e)},insertBefore:function(e,t,n){if(Xn(e)){let t=e;for(;t&&Xn(t);){t=Jn(t).parent}e=null!=t?t:e}Xn(t)&&(t=Jn(t,e)),n&&Xn(n)&&(n=Jn(n).firstChildNode),e.insertBefore(t,n)},removeChild:function(e,t){e.removeChild(t)},appendChild:function(e,t){Xn(t)&&(t=Jn(t,e)),e.appendChild(t)},parentNode:Zn,nextSibling:function(e){var t;if(Xn(e)){const n=Jn(e),s=Zn(n);if(s&&n.lastChildNode){const e=Array.from(s.childNodes),r=e.indexOf(n.lastChildNode);return null!==(t=e[r+1])&&void 0!==t?t:null}return null}return e.nextSibling},tagName:function(e){return e.tagName},setTextContent:function(e,t){e.textContent=t},getTextContent:function(e){return e.textContent},isElement:function(e){return 1===e.nodeType},isText:function(e){return 3===e.nodeType},isComment:function(e){return 8===e.nodeType},isDocumentFragment:Xn};function ts(e,t,n,s,r){return{sel:e,data:t,children:n,text:s,elm:r,key:void 0===t?void 0:t.key}}const ns=Array.isArray;function ss(e){return"string"==typeof e||"number"==typeof e||e instanceof String||e instanceof Number}function rs(e){return void 0===e}function os(e){return void 0!==e}const is=ts("",{},[],void 0,void 0);function as(e,t){var n,s;const r=e.key===t.key,o=(null===(n=e.data)||void 0===n?void 0:n.is)===(null===(s=t.data)||void 0===s?void 0:s.is),i=e.sel===t.sel,a=!(!e.sel&&e.sel===t.sel)||typeof e.text==typeof t.text;return i&&r&&o&&a}function cs(){throw new Error("The document fragment is not supported on this platform.")}function hs(e,t,n){var s;const r={};for(let o=t;o<=n;++o){const t=null===(s=e[o])||void 0===s?void 0:s.key;void 0!==t&&(r[t]=o)}return r}const ls=["create","update","remove","destroy","pre","post"];function us(e,t,n){const s={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},r=void 0!==t?t:es;for(const t of ls)for(const n of e){const e=n[t];void 0!==e&&s[t].push(e)}function o(e){const t=e.id?"#"+e.id:"",n=e.getAttribute("class"),s=n?"."+n.split(" ").join("."):"";return ts(r.tagName(e).toLowerCase()+t+s,{},[],void 0,e)}function i(e){return ts(void 0,{},[],void 0,e)}function a(e,t){return function(){if(0==--t){const t=r.parentNode(e);r.removeChild(t,e)}}}function c(e,t){var o,i,a,h;let l,u=e.data;if(void 0!==u){const t=null===(o=u.hook)||void 0===o?void 0:o.init;os(t)&&(t(e),u=e.data)}const d=e.children,p=e.sel;if("!"===p)rs(e.text)&&(e.text=""),e.elm=r.createComment(e.text);else if(void 0!==p){const n=p.indexOf("#"),o=p.indexOf(".",n),a=n>0?n:p.length,h=o>0?o:p.length,f=-1!==n||-1!==o?p.slice(0,Math.min(a,h)):p,m=e.elm=os(u)&&os(l=u.ns)?r.createElementNS(l,f,u):r.createElement(f,u);for(a<h&&m.setAttribute("id",p.slice(a+1,h)),o>0&&m.setAttribute("class",p.slice(h+1).replace(/\./g," ")),l=0;l<s.create.length;++l)s.create[l](is,e);if(ns(d))for(l=0;l<d.length;++l){const e=d[l];null!=e&&r.appendChild(m,c(e,t))}else ss(e.text)&&r.appendChild(m,r.createTextNode(e.text));const g=e.data.hook;os(g)&&(null===(i=g.create)||void 0===i||i.call(g,is,e),g.insert&&t.push(e))}else if((null===(a=null==n?void 0:n.experimental)||void 0===a?void 0:a.fragments)&&e.children){for(e.elm=(null!==(h=r.createDocumentFragment)&&void 0!==h?h:cs)(),l=0;l<s.create.length;++l)s.create[l](is,e);for(l=0;l<e.children.length;++l){const n=e.children[l];null!=n&&r.appendChild(e.elm,c(n,t))}}else e.elm=r.createTextNode(e.text);return e.elm}function h(e,t,n,s,o,i){for(;s<=o;++s){const o=n[s];null!=o&&r.insertBefore(e,c(o,i),t)}}function l(e){var t,n;const r=e.data;if(void 0!==r){null===(n=null===(t=null==r?void 0:r.hook)||void 0===t?void 0:t.destroy)||void 0===n||n.call(t,e);for(let t=0;t<s.destroy.length;++t)s.destroy[t](e);if(void 0!==e.children)for(let t=0;t<e.children.length;++t){const n=e.children[t];null!=n&&"string"!=typeof n&&l(n)}}}function u(e,t,n,o){for(var i,c;n<=o;++n){let o,h;const d=t[n];if(null!=d)if(os(d.sel)){l(d),o=s.remove.length+1,h=a(d.elm,o);for(let e=0;e<s.remove.length;++e)s.remove[e](d,h);const e=null===(c=null===(i=null==d?void 0:d.data)||void 0===i?void 0:i.hook)||void 0===c?void 0:c.remove;os(e)?e(d,h):h()}else d.children?(l(d),u(e,d.children,0,d.children.length-1)):r.removeChild(e,d.elm)}}function d(e,t,n){var o,i,a,l,p,f,m,g;const v=null===(o=t.data)||void 0===o?void 0:o.hook;null===(i=null==v?void 0:v.prepatch)||void 0===i||i.call(v,e,t);const b=t.elm=e.elm;if(e===t)return;if(void 0!==t.data||os(t.text)&&t.text!==e.text){null!==(a=t.data)&&void 0!==a||(t.data={}),null!==(l=e.data)&&void 0!==l||(e.data={});for(let n=0;n<s.update.length;++n)s.update[n](e,t);null===(m=null===(f=null===(p=t.data)||void 0===p?void 0:p.hook)||void 0===f?void 0:f.update)||void 0===m||m.call(f,e,t)}const k=e.children,w=t.children;rs(t.text)?os(k)&&os(w)?k!==w&&function(e,t,n,s){let o,i,a,l,p=0,f=0,m=t.length-1,g=t[0],v=t[m],b=n.length-1,k=n[0],w=n[b];for(;p<=m&&f<=b;)null==g?g=t[++p]:null==v?v=t[--m]:null==k?k=n[++f]:null==w?w=n[--b]:as(g,k)?(d(g,k,s),g=t[++p],k=n[++f]):as(v,w)?(d(v,w,s),v=t[--m],w=n[--b]):as(g,w)?(d(g,w,s),r.insertBefore(e,g.elm,r.nextSibling(v.elm)),g=t[++p],w=n[--b]):as(v,k)?(d(v,k,s),r.insertBefore(e,v.elm,g.elm),v=t[--m],k=n[++f]):(void 0===o&&(o=hs(t,p,m)),i=o[k.key],rs(i)?r.insertBefore(e,c(k,s),g.elm):(a=t[i],a.sel!==k.sel?r.insertBefore(e,c(k,s),g.elm):(d(a,k,s),t[i]=void 0,r.insertBefore(e,a.elm,g.elm))),k=n[++f]);f<=b&&(l=null==n[b+1]?null:n[b+1].elm,h(e,l,n,f,b,s)),p<=m&&u(e,t,p,m)}(b,k,w,n):os(w)?(os(e.text)&&r.setTextContent(b,""),h(b,null,w,0,w.length-1,n)):os(k)?u(b,k,0,k.length-1):os(e.text)&&r.setTextContent(b,""):e.text!==t.text&&(os(k)&&u(b,k,0,k.length-1),r.setTextContent(b,t.text)),null===(g=null==v?void 0:v.postpatch)||void 0===g||g.call(v,e,t)}return function(e,t){let n,a,h;const l=[];for(n=0;n<s.pre.length;++n)s.pre[n]();for(!function(e,t){return e.isElement(t)}(r,e)?function(e,t){return e.isDocumentFragment(t)}(r,e)&&(e=i(e)):e=o(e),as(e,t)?d(e,t,l):(a=e.elm,h=r.parentNode(a),c(t,l),null!==h&&(r.insertBefore(h,t.elm,r.nextSibling(a)),u(h,[e],0,0))),n=0;n<l.length;++n)l[n].data.hook.insert(l[n]);for(n=0;n<s.post.length;++n)s.post[n]();return t}}function ds(e,t,n){if(e.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==t)for(let e=0;e<t.length;++e){const n=t[e];if("string"==typeof n)continue;const s=n.data;void 0!==s&&ds(s,n.children,n.sel)}}function ps(e,t,n){let s,r,o,i={};if(void 0!==n?(null!==t&&(i=t),ns(n)?s=n:ss(n)?r=n.toString():n&&n.sel&&(s=[n])):null!=t&&(ns(t)?s=t:ss(t)?r=t.toString():t&&t.sel?s=[t]:i=t),void 0!==s)for(o=0;o<s.length;++o)ss(s[o])&&(s[o]=ts(void 0,void 0,void 0,s[o],void 0));return"s"!==e[0]||"v"!==e[1]||"g"!==e[2]||3!==e.length&&"."!==e[3]&&"#"!==e[3]||ds(i,s,e),ts(e,i,s,r,void 0)}function fs(e,t){let n;const s=t.elm;let r=e.data.attrs,o=t.data.attrs;if((r||o)&&r!==o){for(n in r=r||{},o=o||{},o){const e=o[n];r[n]!==e&&(!0===e?s.setAttribute(n,""):!1===e?s.removeAttribute(n):120!==n.charCodeAt(0)?s.setAttribute(n,e):58===n.charCodeAt(3)?s.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,e):58===n.charCodeAt(5)?s.setAttributeNS("http://www.w3.org/1999/xlink",n,e):s.setAttribute(n,e))}for(n in r)n in o||s.removeAttribute(n)}}const ms={create:fs,update:fs};function gs(e,t){let n,s;const r=t.elm;let o=e.data.class,i=t.data.class;if((o||i)&&o!==i){for(s in o=o||{},i=i||{},o)o[s]&&!Object.prototype.hasOwnProperty.call(i,s)&&r.classList.remove(s);for(s in i)n=i[s],n!==o[s]&&r.classList[n?"add":"remove"](s)}}const vs={create:gs,update:gs};const bs=(e,t,n,s=!0)=>ks((r=>r.addEventListener(e,(e=>{const s=t(e);return!1===s&&e.preventDefault(),null==n||n(),s}),{passive:s})));function ks(e){return{insert:t=>e(t.elm)}}const ws=e=>t=>{(e=>e.altKey||e.ctrlKey||e.shiftKey||e.metaKey||document.activeElement instanceof HTMLInputElement||document.activeElement instanceof HTMLTextAreaElement)(t)||("ArrowLeft"==t.key?e.goTo("prev"):"ArrowRight"==t.key?e.goTo("next"):"f"==t.key&&e.flip())},ys=e=>ps("div.lpv__menu.lpv__pane",[ps("button.lpv__menu__entry.lpv__menu__flip.lpv__fbt",{hook:bs("click",e.flip)},e.translate("flipTheBoard")),ps("a.lpv__menu__entry.lpv__menu__analysis.lpv__fbt",{attrs:{href:e.analysisUrl(),target:"_blank"}},e.translate("analysisBoard")),ps("a.lpv__menu__entry.lpv__menu__practice.lpv__fbt",{attrs:{href:e.practiceUrl(),target:"_blank"}},e.translate("practiceWithComputer")),e.opts.menu.getPgn.enabled?ps("button.lpv__menu__entry.lpv__menu__pgn.lpv__fbt",{hook:bs("click",e.togglePgn)},e.translate("getPgn")):void 0,Cs(e)]),Cs=e=>{const t=e.game.metadata.externalLink;return t&&ps("a.lpv__menu__entry.lpv__fbt",{attrs:{href:t,target:"_blank"}},e.translate(e.game.metadata.isLichess?"viewOnLichess":"viewOnSite"))},Ss=e=>ps("div.lpv__controls",["board"==e.pane?void 0:Es(e,"first","step-backward"),Es(e,"prev","left-open"),ps("button.lpv__fbt.lpv__controls__menu.icon",{class:{active:"board"!=e.pane,"icon-ellipsis-vert":"board"==e.pane},hook:bs("click",e.toggleMenu)},"board"==e.pane?void 0:"X"),Es(e,"next","right-open"),"board"==e.pane?void 0:Es(e,"last","step-forward")]),Es=(e,t,n)=>ps(`button.lpv__controls__goto.lpv__controls__goto--${t}.lpv__fbt.icon.icon-${n}`,{class:{disabled:"board"==e.pane&&!e.canGoTo(t)},hook:ks((n=>function(e,t,n){for(const s of["touchstart","mousedown"])e.addEventListener(s,(e=>{t(e),e.preventDefault(),n&&n()}),{passive:!1})}(n,(n=>function(e,t){const n=()=>{e(),s=Math.max(100,s-s/15),r=setTimeout(n,s)};let s=350,r=setTimeout(n,500);e();const o="touchstart"==t.type?"touchend":"mouseup";document.addEventListener(o,(()=>clearTimeout(r)),{once:!0})}((()=>e.goTo(t)),n)))))}),xs=e=>ps("div.lpv__side",ps("div.lpv__moves",{hook:{insert:t=>{const n=t.elm;e.path.empty()||Ts(e,n),n.addEventListener("mousedown",(t=>{const n=t.target.getAttribute("p");n&&e.toPath(new it(n))}),{passive:!0})},postpatch:(t,n)=>{e.autoScrollRequested&&(Ts(e,n.elm),e.autoScrollRequested=!1)}}},[...e.game.initial.comments.map(Ms),...As(e)])),_s=()=>ps("move.empty","..."),qs=e=>ps("index",[e,"."]),Ms=e=>ps("comment",e),Os=e=>Math.floor((e.ply-1)/2)+1,As=e=>{const t=Ns(e),n=[];let s,r=e.game.moves.children.slice(1);for("black"==e.game.initial.pos.turn&&e.game.mainline[0]&&n.push(qs(e.game.initial.pos.fullmoves),_s());s=(s||e.game.moves).children[0];){const e=s.data,o=e.ply%2==1;o&&n.push(qs(Os(e))),n.push(t(e));const i=o&&(r.length||e.comments.length)&&s.children.length;i&&n.push(_s()),e.comments.forEach((e=>n.push(Ms(e)))),r.forEach((e=>n.push(Ps(t,e)))),i&&n.push(qs(Os(e)),_s()),r=s.children.slice(1)}return n},Ps=(e,t)=>ps("variation",[...t.data.startingComments.map(Ms),...Rs(e,t)]),Rs=(e,t)=>{let n=[],s=[];t.data.ply%2==0&&n.push(ps("index",[Os(t.data),"..."]));do{const r=t.data;r.ply%2==1&&n.push(ps("index",[Os(r),"."])),n.push(e(r)),r.comments.forEach((e=>n.push(Ms(e)))),s.forEach((t=>{n=[...n,ps("paren.open","("),...Rs(e,t),ps("paren.close",")")]})),s=t.children.slice(1),t=t.children[0]}while(t);return n},Ns=e=>t=>ps("move",{class:{current:e.path.equals(t.path),ancestor:e.path.contains(t.path),good:t.nags.includes(1),mistake:t.nags.includes(2),brilliant:t.nags.includes(3),blunder:t.nags.includes(4),interesting:t.nags.includes(5),inaccuracy:t.nags.includes(6)},attrs:{p:t.path.path}},t.san),Ts=(e,t)=>{const n=t.querySelector(".current");t.scrollTop=n?n.offsetTop-t.offsetHeight/2+n.offsetHeight:e.path.empty()?0:99999};function Bs(e,t){const n="bottom"==t?e.orientation():a(e.orientation()),s=e.game.players[n],r=[s.title?ps("span.lpv__player__title",s.title):void 0,ps("span.lpv__player__name",s.name),s.rating?ps("span.lpv__player__rating",["(",s.rating,")"]):void 0];return ps(`div.lpv__player.lpv__player--${t}`,[s.isLichessUser?ps("a.lpv__player__person.ulpt.user-link",{attrs:{href:`${e.opts.lichess}/@/${s.name}`}},r):ps("span.lpv__player__person",r),e.opts.showClocks?Ls(e,n):void 0])}const Ls=(e,t)=>{const n=e.curData(),s=n.clocks&&n.clocks[t];return null==typeof s?void 0:ps("div.lpv__player__clock",{class:{active:t==n.turn}},Ks(s))},Ks=e=>{if(!e&&0!==e)return["-"];const t=new Date(1e3*e),n=zs(t.getUTCMinutes())+":"+zs(t.getUTCSeconds());return e>=3600?[Math.floor(e/3600)+":"+n]:[n]},zs=e=>(e<10?"0":"")+e;function Ds(e){const t=e.opts;return ps(`div.${`lpv.lpv--moves-${t.showMoves}.lpv--controls-${t.showControls}${t.classes?"."+t.classes.replace(" ","."):""}`}`,{class:{"lpv--menu":"board"!=e.pane,"lpv--players":"auto"==t.showPlayers?e.game.hasPlayerName():t.showPlayers},attrs:{tabindex:0},hook:ks((t=>{e.setGround(Qn(t.querySelector(".cg-wrap"),Us(e,t))),t.addEventListener("keydown",ws(e))}))},[t.showPlayers?Bs(e,"top"):void 0,Is(e),t.showPlayers?Bs(e,"bottom"):void 0,t.showControls?Ss(e):void 0,t.showMoves?xs(e):void 0,"menu"==e.pane?ys(e):"pgn"==e.pane?$s(e):void 0])}const Is=e=>ps("div.lpv__board",{hook:ks((t=>{t.addEventListener("click",e.focus),e.opts.scrollToMove&&!("ontouchstart"in window)&&t.addEventListener("wheel",function(e){let t=0;return n=>{t+=n.deltaY*(n.deltaMode?40:1),Math.abs(t)>=4?(e(n,!0),t=0):e(n,!1)}}(((t,n)=>{t.preventDefault(),t.deltaY>0&&n?e.goTo("next",!1):t.deltaY<0&&n&&e.goTo("prev",!1)})))}))},ps("div.cg-wrap")),$s=e=>{const t=new Blob([e.opts.pgn],{type:"text/plain"});return ps("div.lpv__pgn.lpv__pane",[ps("a.lpv__pgn__download.lpv__fbt",{attrs:{href:window.URL.createObjectURL(t),download:e.opts.menu.getPgn.fileName||`${e.game.title()}.pgn`}},e.translate("download")),ps("textarea.lpv__pgn__text",e.opts.pgn)])},Us=(e,t)=>({viewOnly:!e.opts.drawArrows,addDimensionsCssVarsTo:t,drawable:{enabled:e.opts.drawArrows,visible:!0},disableContextMenu:e.opts.drawArrows,...e.opts.chessground||{},movable:{free:!1},draggable:{enabled:!1},selectable:{enabled:!1},...e.cgState()}),Fs={pgn:"*",fen:void 0,showPlayers:"auto",showClocks:!0,showMoves:"auto",showControls:!0,scrollToMove:!0,orientation:"white",initialPly:0,chessground:{},drawArrows:!0,menu:{getPgn:{enabled:!0,fileName:void 0}},lichess:"https://lichess.org",classes:void 0};function Gs(e,t){const n={...Fs};return Vs(n,t),n.fen&&(n.pgn=`[FEN "${n.fen}"]\n${n.pgn}`),n.classes||(n.classes=e.className),n}function Vs(e,t){for(const n in t)void 0!==t[n]&&(js(e[n])&&js(t[n])?Vs(e[n],t[n]):e[n]=t[n])}function js(e){if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||null===t}return function(e,t){const n=us([vs,ms]),s=Gs(e,t),r=new mt(s,(function(){i=n(i,Ds(r))})),o=Ds(r);e.innerHTML="";let i=n(e,o);return r.div=i.elm,r}}();
